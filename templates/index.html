<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Quantum Commander</title>
  <link rel="icon" href="/static/qc-icon.png" type="image/png" />
  <style>
    :root {
      --bg: #0b0c10;
      --panel: #0f1318;
      --card: #11161d;
      --ink: #e6e6e6;
      --muted: #9aa0a6;
      --accent: #5eead4;
      --accent-2: #3cc7b6;
      --danger: #ff6b6b;
      --success: #69db7c;
      --warning: #ff922b;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 16px;
      --transition: all 0.2s ease;
      --sidebar-width: 280px;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    html, body {
      height: 100%;
      margin: 0;
      background: radial-gradient(1200px 800px at 20% -10%, rgba(94,234,212,.12), transparent),
                radial-gradient(900px 600px at 120% 120%, rgba(60,199,182,.08), transparent),
                var(--bg);
      color: var(--ink);
      font: 14px/1.6 ui-sans-serif, system-ui, Segoe UI, Inter, Roboto, Arial;
      overflow: hidden;
    }
    
    .app {
      display: grid;
      grid-template-columns: var(--sidebar-width) 1fr;
      gap: 14px;
      height: 100vh;
      padding: 14px;
    }
    
    /* Sidebar */
    .sidebar {
      background: linear-gradient(180deg, rgba(17,22,29,.9), rgba(17,22,29,.6));
      backdrop-filter: blur(6px);
      border: 1px solid #1e2630;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 14px;
      border-bottom: 1px solid #1e2630;
    }
    
    .brand img {
      width: 22px;
      height: 22px;
      filter: drop-shadow(0 0 6px rgba(94,234,212,.4));
    }
    
    .brand h1 {
      font-size: 15px;
      margin: 0;
      color: var(--accent);
    }
    
    .side-actions {
      padding: 10px;
      display: grid;
      gap: 8px;
    }
    
    .btn {
      background: linear-gradient(180deg, #15222a, #101820);
      border: 1px solid #253241;
      color: #cfe9e5;
      padding: 10px 12px;
      border-radius: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      justify-content: center;
      transition: var(--transition);
      outline: none;
      font-size: 13px;
    }
    
    .btn:hover, .btn:focus {
      border-color: #2f4456;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    .btn.primary {
      background: linear-gradient(180deg, #19c8ab, #12a08c);
      border: 0;
      color: #052a24;
      font-weight: 700;
    }
    
    .btn.ghost {
      background: transparent;
      border: 1px dashed #2a3846;
      color: #a9c7c2;
    }
    
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    
    .btn-sm {
      padding: 6px 10px;
      font-size: 12px;
    }
    
    .history {
      flex: 1;
      overflow: auto;
      padding: 8px;
    }
    
    .hist-item {
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #1f2833;
      background: #0e141a;
      margin: 6px 0;
      cursor: pointer;
      transition: var(--transition);
      position: relative;
    }
    
    .hist-item:hover, .hist-item:focus {
      border-color: #2a3b4b;
      background: #101821;
    }
    
    .hist-item.active {
      border-color: var(--accent);
      background: rgba(94,234,212,0.1);
    }
    
    .hist-item-title {
      font-size: 13px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      padding-right: 20px;
    }
    
    .hist-item-time {
      color: var(--muted);
      font-size: 11px;
      margin-top: 4px;
    }
    
    .hist-item-delete {
      position: absolute;
      right: 8px;
      top: 8px;
      opacity: 0;
      transition: var(--transition);
      background: transparent;
      border: none;
      color: var(--muted);
      cursor: pointer;
      padding: 2px;
      border-radius: 4px;
    }
    
    .hist-item:hover .hist-item-delete {
      opacity: 1;
    }
    
    .hist-item-delete:hover {
      color: var(--danger);
      background: rgba(255,107,107,0.1);
    }
    
    .hist-empty {
      color: var(--muted);
      font-size: 12px;
      padding: 8px;
      text-align: center;
    }
    
    /* Main */
    .main {
      display: grid;
      grid-template-rows: auto 1fr auto;
      gap: 12px;
      height: 100%;
    }
    
    header {
      display: flex;
      align-items: center;
      gap: 12px;
      background: linear-gradient(180deg, rgba(17,22,29,.95), rgba(17,22,29,.8));
      border: 1px solid #1e2630;
      border-radius: var(--radius);
      padding: 10px 12px;
      box-shadow: var(--shadow);
    }
    
    .badge {
      padding: 4px 8px;
      border-radius: 999px;
      background: #122027;
      border: 1px solid #1f323d;
      color: #cde;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .status-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      display: inline-block;
    }
    
    .status-connected {
      background: var(--success);
    }
    
    .status-connecting {
      background: var(--warning);
    }
    
    .status-disconnected {
      background: var(--danger);
    }
    
    .spacer {
      flex: 1;
    }
    
    .board {
      background: linear-gradient(180deg, rgba(17,22,29,.9), rgba(17,22,29,.7));
      border: 1px solid #1e2630;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
      overflow: auto;
      position: relative;
      scroll-behavior: smooth;
    }
    
    .msg {
      max-width: 900px;
      margin: 0 auto 14px auto;
      padding: 12px 14px;
      border-radius: 14px;
      background: #0f1722;
      border: 1px solid #1f2833;
      position: relative;
      animation: fadeIn 0.3s ease;
    }
    
    .msg.me {
      background: #121b26;
      border-color: #243043;
    }
    
    .msg .meta {
      color: var(--muted);
      font-size: 12px;
      margin-top: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .msg .copy {
      position: absolute;
      right: 10px;
      top: 10px;
      background: #17222b;
      border: 1px solid #22303d;
      color: #cfe;
      padding: 4px 6px;
      border-radius: 8px;
      cursor: pointer;
      transition: var(--transition);
      opacity: 0.7;
      font-size: 12px;
    }
    
    .msg .copy:hover {
      opacity: 1;
    }
    
    .msg pre {
      background: #0a0e14;
      padding: 10px;
      border-radius: 8px;
      overflow: auto;
      margin: 8px 0;
    }
    
    .msg code {
      font-family: monospace;
      background: #0a0e14;
      padding: 2px 4px;
      border-radius: 4px;
    }
    
    .msg table {
      border-collapse: collapse;
      width: 100%;
      margin: 8px 0;
    }
    
    .msg th, .msg td {
      border: 1px solid #2a3846;
      padding: 8px;
    }
    
    .msg th {
      background: #131c26;
    }
    
    .msg ul, .msg ol {
      margin: 8px 0;
      padding-left: 20px;
    }
    
    .msg blockquote {
      border-left: 3px solid #2a3846;
      padding-left: 12px;
      margin: 8px 0;
      color: var(--muted);
    }
    
    .composer {
      display: flex;
      gap: 10px;
      align-items: flex-end;
    }
    
    textarea {
      flex: 1;
      min-height: 64px;
      max-height: 220px;
      resize: vertical;
      background: #0d1218;
      color: var(--ink);
      border: 1px solid #1e2630;
      border-radius: 14px;
      padding: 12px;
      box-shadow: inset 0 0 0 1px rgba(94,234,212,.05);
      transition: var(--transition);
      outline: none;
      font-family: inherit;
      line-height: 1.5;
    }
    
    textarea:focus {
      border-color: #3cc7b6;
      box-shadow: 0 0 0 2px rgba(94,234,212,0.2);
    }
    
    .send {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .panel {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      padding: 8px 0;
    }
    
    .panel label {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      color: var(--muted);
    }
    
    select, input[type="number"] {
      background: #0d1218;
      border: 1px solid #1e2630;
      color: #e6e6e6;
      border-radius: 10px;
      padding: 8px;
      transition: var(--transition);
      outline: none;
      font-family: inherit;
    }
    
    select:focus, input[type="number"]:focus {
      border-color: #3cc7b6;
    }
    
    .slider {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    input[type="range"] {
      accent-color: var(--accent);
      outline: none;
    }
    
    .toast {
      position: fixed;
      right: 16px;
      bottom: 16px;
      background: #0d161c;
      border: 1px solid #1f2b33;
      padding: 10px 12px;
      border-radius: 12px;
      box-shadow: var(--shadow);
      opacity: 0;
      transform: translateY(10px);
      transition: .25s;
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }
    
    .toast.success {
      background: rgba(105,219,124,0.15);
      border-color: rgba(105,219,124,0.3);
    }
    
    .toast.error {
      background: rgba(255,107,107,0.15);
      border-color: rgba(255,107,107,0.3);
    }
    
    .toast.warning {
      background: rgba(255,146,43,0.15);
      border-color: rgba(255,146,43,0.3);
    }
    
    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(94,234,212,0.3);
      border-radius: 50%;
      border-top-color: var(--accent);
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .mobile-menu-btn {
      display: none;
      background: transparent;
      border: none;
      color: var(--muted);
      cursor: pointer;
      padding: 8px;
      position: fixed;
      top: 16px;
      left: 16px;
      z-index: 101;
      background: rgba(15,19,24,0.8);
      border-radius: 8px;
      backdrop-filter: blur(4px);
    }
    
    .typing-indicator {
      display: flex;
      align-items: center;
      gap: 4px;
      color: var(--muted);
      font-size: 12px;
      margin: 8px 0;
    }
    
    .typing-dot {
      width: 4px;
      height: 4px;
      background: var(--muted);
      border-radius: 50%;
      animation: typing 1.4s infinite;
    }
    
    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }
    
    @keyframes typing {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-4px); }
    }
    
    .scroll-to-bottom {
      position: absolute;
      bottom: 24px;
      right: 24px;
      background: rgba(17,22,29,0.8);
      border: 1px solid #1e2630;
      color: var(--accent);
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      opacity: 0;
      transition: var(--transition);
      backdrop-filter: blur(4px);
      z-index: 10;
    }
    
    .scroll-to-bottom.visible {
      opacity: 1;
    }
    
    .welcome-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      text-align: center;
      padding: 20px;
      color: var(--muted);
    }
    
    .welcome-title {
      font-size: 24px;
      margin-bottom: 12px;
      color: var(--accent);
    }
    
    .welcome-subtitle {
      font-size: 16px;
      margin-bottom: 24px;
      max-width: 600px;
    }
    
    .welcome-features {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-top: 24px;
      max-width: 800px;
    }
    
    .feature-card {
      background: rgba(17,22,29,0.5);
      border-radius: 12px;
      padding: 16px;
      border: 1px solid #1e2630;
    }
    
    .feature-icon {
      font-size: 24px;
      margin-bottom: 12px;
      color: var(--accent);
    }
    
    .settings-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(4px);
    }
    
    .settings-modal.open {
      display: flex;
    }
    
    .settings-content {
      background: var(--panel);
      border-radius: var(--radius);
      border: 1px solid #1e2630;
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      overflow: auto;
      padding: 20px;
      box-shadow: var(--shadow);
    }
    
    .settings-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 1px solid #1e2630;
    }
    
    .settings-close {
      background: transparent;
      border: none;
      color: var(--muted);
      cursor: pointer;
      font-size: 20px;
    }
    
    .settings-group {
      margin-bottom: 20px;
    }
    
    .settings-group-title {
      font-size: 16px;
      margin-bottom: 12px;
      color: var(--accent);
    }
    
    .settings-option {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid rgba(30,38,48,0.5);
    }
    
    @media (max-width: 980px) {
      .app {
        grid-template-columns: 1fr;
        padding: 0;
      }
      
      .sidebar {
        display: none;
        position: fixed;
        left: 0;
        top: 0;
        height: 100%;
        z-index: 100;
        width: var(--sidebar-width);
        transform: translateX(-100%);
        transition: transform 0.3s ease;
        border-radius: 0;
      }
      
      .sidebar.open {
        transform: translateX(0);
      }
      
      .mobile-menu-btn {
        display: block;
      }
      
      .overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        z-index: 99;
      }
      
      .overlay.open {
        display: block;
      }
      
      .main {
        border-radius: 0;
        height: 100vh;
      }
      
      .panel {
        padding: 10px;
      }
      
      .composer {
        padding: 10px;
      }
      
      header {
        border-radius: 0;
        border-left: none;
        border-right: none;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- Mobile menu button -->
    <button class="mobile-menu-btn" id="mobileMenuBtn" aria-label="Open menu">‚ò∞</button>
    <div class="overlay" id="overlay"></div>
    
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="brand">
        <img src="/static/qc-icon.png" alt="QC" />
        <h1>Quantum Commander</h1>
      </div>
      <div class="side-actions">
        <button class="btn primary" id="newChat">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 5V19M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          New chat
        </button>
        <button class="btn" id="exportChat">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M21 15V19C21 19.5304 20.7893 20.0391 20.4142 20.4142C20.0391 20.7893 19.5304 21 19 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V15M17 8L12 3M12 3L7 8M12 3V15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          Export transcript
        </button>
        <button class="btn" id="botsBtn">üß© Bots</button>
        <button class="btn" id="ensembleBtn">üß† Ensemble</button>
        <button class="btn" id="skillsBtn">üß† Skills</button>
        <button class="btn ghost" id="clearHistory">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M19 7L18.1327 19.1425C18.0579 20.1891 17.187 21 16.1378 21H7.86224C6.81296 21 5.94208 20.1891 5.86732 19.1425L5 7M10 11V17M14 11V17M15 7V4C15 3.44772 14.5523 3 14 3H10C9.44772 3 9 3.44772 9 4V7M4 7H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          Clear history
        </button>
      </div>
      <div class="history" id="historyList">
        <div class="hist-empty">No conversations yet.</div>
      </div>
    </aside>

    <!-- Main -->
    <section class="main">
      <header>
        <span class="badge">
          <span class="status-indicator" id="statusIndicator"></span>
          WS: <span id="wsState">connecting‚Ä¶</span>
        </span>
        <span class="badge">Model: <span id="modelActive">loading‚Ä¶</span></span>
        <span class="badge">Provider: <span id="providerActive">loading‚Ä¶</span></span>
        <span class="badge" id="ensembleHdr" style="display:none">Ensemble</span>
        <span class="badge" id="ensOverrideHdr" style="display:none">Override</span>
        <span class="badge" id="dbHdr" title="DB backend">DB: ‚Ä¶</span>
        <button class="btn btn-sm" id="dbInitBtn">Init DB</button>
        <div class="spacer"></div>
        <button class="btn btn-sm" id="reconnect">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M23 4L23 10L17 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M1 20L1 14L7 14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M3.51 9C4.01717 7.56678 4.87913 6.2854 6.01547 5.27542C7.1518 4.26543 8.52547 3.55976 10.0083 3.22426C11.4911 2.88875 13.0348 2.93434 14.4952 3.35677C15.9556 3.77921 17.2853 4.56471 18.36 5.64L23 10M1 14L5.64 18.36C6.71475 19.4353 8.04437 20.2208 9.50481 20.6432C10.9652 21.0657 12.5089 21.1112 13.9917 20.7757C15.4745 20.4402 16.8482 19.7346 17.9845 18.7246C19.1209 17.7146 19.9828 16.4332 20.49 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          Reconnect
        </button>
        <button class="btn btn-sm" id="settingsBtn">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 15C13.6569 15 15 13.6569 15 12C15 10.3431 13.6569 9 12 9C10.3431 9 9 10.3431 9 12C9 13.6569 10.3431 15 12 15Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M19.4 15C19.2669 15.3 19.2 15.6 19.2 16C19.2 16.5 19.4 17 19.7 17.3L19.9 17.5C20.3 17.9 20.5 18.4 20.5 19C20.5 19.6 20.3 20.1 19.9 20.5C19.5 20.9 19 21.1 18.4 21.1C17.8 21.1 17.3 20.9 16.9 20.5L16.7 20.3C16.4 20 15.9 19.8 15.4 19.8C15.1 19.8 14.8 19.7 14.5 19.6C14.2 19.5 13.9 19.4 13.6 19.4C13.1 19.4 12.6 19.6 12.3 19.9C11.9 20.3 11.7 20.8 11.7 21.4C11.7 22 11.5 22.5 11.1 22.9C10.7 23.3 10.2 23.5 9.6 23.5C9 23.5 8.5 23.3 8.1 22.9C7.7 22.5 7.5 22 7.5 21.4C7.5 20.8 7.7 19.3 8.1 19.9C8.4 19.6 8.6 19.1 8.6 18.6C8.6 18.3 8.5 18 8.4 17.7C8.3 17.4 8.2 17.1 8.2 16.8C8.2 16.3 8 15.8 7.7 15.5L7.5 15.3C7.1 14.9 6.6 14.7 6 14.7C5.4 14.7 4.9 14.9 4.5 15.3C4.1 15.7 3.9 16.2 3.9 16.8C3.9 17.4 4.1 17.9 4.5 18.3L4.7 18.5C5 18.8 5.2 19.3 5.2 19.8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M2.1 15H2.1C1.5 15 1 14.5 1 13.9V10.1C1 9.5 1.5 9 2.1 9H2.1C2.7 9 3.2 9.5 3.2 10.1V13.9C3.2 14.5 2.7 15 2.1 15Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M10.1 3.2H13.9C14.5 3.2 15 2.7 15 2.1V2.1C15 1.5 14.5 1 13.9 1H10.1C9.5 1 9 1.5 9 2.1V2.1C9 2.7 9.5 3.2 10.1 3.2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M21.9 9H21.9C21.3 9 20.8 9.5 20.8 10.1V13.9C20.8 14.5 21.3 15 21.9 15H21.9C22.5 15 23 14.5 23 13.9V10.1C23 9.5 22.5 9 21.9 9Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M13.9 23H10.1C9.5 23 9 22.5 9 21.9V21.9C9 21.3 9.5 20.8 10.1 20.8H13.9C14.5 20.8 15 21.3 15 21.9V21.9C15 22.5 14.5 23 13.9 23Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          Settings
        </button>
        <button class="btn btn-sm" id="chipFinance">üíπ Finance</button>
        <button class="btn btn-sm" id="chipFund">üéØ Fundraising</button>
        <button class="btn btn-sm" id="chipLegal">‚öñÔ∏è Legal/Taxes</button>
        <button class="btn btn-sm" id="chipContent">üé¨ Content</button>
        <button class="btn btn-sm" id="chipOps">üõ†Ô∏è Ops</button>
        <button class="btn btn-sm" id="opsBtnHead"># Root Ops</button>
      </header>

      <div class="board" id="board" aria-live="polite" aria-busy="false">
        <div class="welcome-container" id="welcomeContainer">
          <h2 class="welcome-title">Welcome to Quantum Commander</h2>
          <p class="welcome-subtitle">A powerful AI chat interface with advanced capabilities. Start a conversation or explore the features below.</p>
          
          <div class="welcome-features">
            <div class="feature-card">
              <div class="feature-icon">üí¨</div>
              <h3>AI Conversations</h3>
              <p>Chat with advanced AI models in real-time with streaming responses</p>
            </div>
            <div class="feature-card">
              <div class="feature-icon">üìö</div>
              <h3>Chat History</h3>
              <p>Your conversations are saved and can be revisited anytime</p>
            </div>
            <div class="feature-card">
              <div class="feature-icon">‚öôÔ∏è</div>
              <h3>Customizable</h3>
              <p>Adjust parameters like temperature and token limits</p>
            </div>
            <div class="feature-card">
              <div class="feature-icon">üîí</div>
              <h3>Privacy Focused</h3>
              <p>Your data stays on your device with local storage</p>
            </div>
          </div>
        </div>
      </div>
      
      <button class="scroll-to-bottom" id="scrollToBottom" aria-label="Scroll to bottom">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 5V19M12 19L19 12M12 19L5 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>

      <div class="panel">
        <label>Transport <select id="transport"><option value="ws">WS</option><option value="sse">SSE</option></select></label>
        <button class="btn btn-sm" id="uploadBtn">Upload</button>
        <label>Bot
          <select id="botSelect"><option value="">(none)</option></select>
        </label>
        <label>Provider
          <select id="provider">
            <!-- populated from /health -->
          </select>
        </label>
        <label>Model
          <select id="model">
            <!-- populated from /health -->
          </select>
        </label>
        <label class="slider">Temp <input id="temp" type="range" min="0" max="2" step="0.1"> <span id="tempVal">0.2</span></label>
        <label>Max tokens <input id="maxTokens" type="number" min="1" step="50" value="800" style="width:100px"></label>
        <label><input type="checkbox" id="stream" checked> Stream</label>
        <button class="btn btn-sm" id="clearBtn">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M19 7L18.1327 19.1425C18.0579 20.1891 17.187 21 16.1378 21H7.86224C6.81296 21 5.94208 20.1891 5.86732 19.1425L5 7M10 11V17M14 11V17M15 7V4C15 3.44772 14.5523 3 14 3H10C9.44772 3 9 3.44772 9 4V7M4 7H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          Clear chat
        </button>
      </div>

      <div class="composer">
        <textarea id="input" placeholder="Type a message‚Ä¶ (Shift+Enter for newline)" aria-label="Type your message"></textarea>
        <div class="send">
          <button class="btn primary" id="send">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M22 2L11 13M22 2L15 22L11 13L2 9L22 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Send ‚Üµ
          </button>
          <button class="btn" id="stop">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <rect x="5" y="5" width="14" height="14" rx="2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Stop
          </button>
          <button class="btn" id="ensPromptBtn" title="Ensemble per-message settings" style="display:none">‚öôÔ∏è</button>
        </div>
      </div>
    </section>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <div id="dbModal" class="settings-modal"><div class="settings-content" style="max-width:780px">
    <div class="settings-header"><h2>Supabase status</h2><button class="settings-close" id="dbClose">√ó</button></div>
    <div class="settings-group">
      <h3 class="settings-group-title">Status</h3>
      <pre id="dbStatus" style="background:#0a0e14;border:1px solid #1e2630;color:#e6e6e6;border-radius:8px;padding:8px;max-height:260px;overflow:auto"></pre>
    </div>
    <div class="settings-group">
      <h3 class="settings-group-title">Create tables (copy & run in Supabase SQL)</h3>
      <textarea id="dbSQL" rows="10" style="width:100%;background:#0d1218;border:1px solid #1e2630;color:#e6e6e6;border-radius:8px;padding:8px"></textarea>
      <div class="settings-option"><button class="btn" id="dbCopy">Copy SQL</button><button class="btn" id="dbRefresh">Refresh</button><button class="btn" id="dbOpen">Open dashboard</button></div>
    </div>
  </div></div>

  <div id="opsModal" class="settings-modal"><div class="settings-content" style="max-width:760px">
    <div class="settings-header"><h2>Root Ops</h2><button class="settings-close" id="opsClose">√ó</button></div>
    <div class="settings-group">
      <h3 class="settings-group-title">Token</h3>
      <div class="settings-option"><span>OPS_TOKEN</span><input id="opsToken" type="password" placeholder="Paste token" style="background:#0d1218;border:1px solid #1e2630;color:#e6e6e6;border-radius:6px;padding:6px;width:320px"></div>
      <div class="settings-option"><button class="btn primary" id="opsSave">Save</button><button class="btn" id="opsTest">Test</button><small id="opsStatus" style="margin-left:8px;color:#9aa0a6"></small></div>
    </div>
    <div class="settings-group">
      <h3 class="settings-group-title">Run command as root</h3>
      <div class="settings-option" style="align-items:flex-start"><span>Command</span><textarea id="opsCmd" rows="3" style="flex:1;background:#0d1218;border:1px solid #1e2630;color:#e6e6e6;border-radius:6px;padding:8px;width:100%" placeholder="id"></textarea></div>
      <div class="settings-option"><label style="display:flex;align-items:center;gap:6px"><input type="checkbox" id="opsConfirm"> I understand and confirm if the command is destructive</label><div style="display:flex;gap:8px"><button class="btn primary" id="opsRun">Run</button><button class="btn" id="opsOpenTerm">Open full terminal</button></div></div>
      <div class="settings-option" style="align-items:flex-start"><span>Output</span><pre id="opsOut" style="flex:1;max-height:280px;overflow:auto;background:#0a0e14;border:1px solid #1e2630;border-radius:8px;padding:8px;white-space:pre-wrap"></pre></div>
      <div class="settings-option" style="align-items:center;gap:8px"><span>Save as skill</span>
        <input id="opsSkillName" placeholder="e.g., update system" style="background:#0d1218;border:1px solid #1e2630;color:#e6e6e6;border-radius:6px;padding:6px;width:240px">
        <label style="display:flex;align-items:center;gap:6px"><input type="checkbox" id="opsSkillRoot" checked> Root</label>
        <button class="btn" id="opsSkillSave">Save</button>
      </div>
    </div>
  </div></div>

  <div class="settings-modal" id="uploadModal"><div class="settings-content"><div class="settings-header"><h2>Upload file</h2><button class="settings-close" id="uploadClose">√ó</button></div><input type="file" id="uploadInput" /><div class="side-actions" style="margin-top:12px"><button class="btn primary" id="uploadDo">Upload</button></div><div id="uploadList" style="margin-top:12px;font-size:12px;color:#9aa0a6"></div></div></div>

  <div class="settings-modal" id="settingsModal">
    <div class="settings-content">
      <div class="settings-header">
        <h2>Settings</h2>
        <button class="settings-close" id="settingsClose">√ó</button>
      </div>
      
      <div class="settings-group">
        <h3 class="settings-group-title">API Configuration</h3>
        <div class="settings-option">
          <span>API Base URL</span>
          <input type="text" id="apiBaseUrl" placeholder="https://api.example.com" style="background: #0d1218; border: 1px solid #1e2630; color: #e6e6e6; border-radius: 6px; padding: 6px; width: 200px;">
        </div>
        <div class="settings-option">
          <span>API Key</span>
          <input type="password" id="apiKey" placeholder="Your API key" style="background: #0d1218; border: 1px solid #1e2630; color: #e6e6e6; border-radius: 6px; padding: 6px; width: 200px;">
        </div>
      </div>
      
      <div class="settings-group">
        <h3 class="settings-group-title">Interface</h3>
        <div class="settings-option">
          <span>Dark Mode</span>
          <input type="checkbox" id="darkMode" checked>
        </div>
        <div class="settings-option">
          <span>Animations</span>
          <input type="checkbox" id="animations" checked>
        </div>
        <div class="settings-option">
          <span>Font Size</span>
          <select id="fontSize" style="background: #0d1218; border: 1px solid #1e2630; color: #e6e6e6; border-radius: 6px; padding: 6px;">
            <option value="14px">Small</option>
            <option value="16px" selected>Medium</option>
            <option value="18px">Large</option>
          </select>
        </div>
      </div>
      
      <div class="settings-group">
        <h3 class="settings-group-title">Chat Behavior</h3>
        <div class="settings-option">
          <span>Auto-scroll</span>
          <input type="checkbox" id="autoScroll" checked>
        </div>
        <div class="settings-option">
          <span>Send with Enter</span>
          <input type="checkbox" id="sendWithEnter" checked>
        </div>
        <div class="settings-option">
          <span>Show timestamps</span>
          <input type="checkbox" id="showTimestamps" checked>
        </div>
        <div class="settings-option">
          <span>Auto transport defaults</span>
          <input type="checkbox" id="autoTransport" checked>
        </div>
        <div class="settings-option">
          <span>Enable chat root exec (!root ...)</span>
          <input type="checkbox" id="chatRootExec">
        </div>
      </div>
      
      <div class="side-actions" style="margin-top: 20px;">
        <button class="btn primary" id="saveSettings">Save Settings</button>
        <button class="btn ghost" id="resetSettings">Reset to Defaults</button>
      </div>
  </div>
  </div>

  <div id="botModal" class="settings-modal"><div class="settings-content" style="max-width:720px">
    <div class="settings-header"><h2>Bots</h2><button class="settings-close" id="botClose">√ó</button></div>
    <div class="settings-group">
      <h3 class="settings-group-title">Create Bot</h3>
      <div class="settings-option"><span>Name</span><input id="botName" placeholder="Finance Analyst" style="background:#0d1218;border:1px solid #1e2630;color:#e6e6e6;border-radius:6px;padding:6px;width:260px"></div>
      <div class="settings-option"><span>Emoji</span><input id="botEmoji" value="ü§ñ" style="background:#0d1218;border:1px solid #1e2630;color:#e6e6e6;border-radius:6px;padding:6px;width:100px"></div>
      <div class="settings-option"><span>Provider</span><input id="botProvider" value="openai" style="background:#0d1218;border:1px solid #1e2630;color:#e6e6e6;border-radius:6px;padding:6px;width:160px"></div>
      <div class="settings-option"><span>Model</span><input id="botModel" value="gpt-5" style="background:#0d1218;border:1px solid #1e2630;color:#e6e6e6;border-radius:6px;padding:6px;width:200px"></div>
      <div class="settings-option"><span>Temperature</span><input id="botTemp" type="number" step="0.1" value="0.2" style="background:#0d1218;border:1px solid #1e2630;color:#e6e6e6;border-radius:6px;padding:6px;width:120px"></div>
      <div class="settings-option"><span>Max tokens</span><input id="botMaxToks" type="number" value="800" style="background:#0d1218;border:1px solid #1e2630;color:#e6e6e6;border-radius:6px;padding:6px;width:120px"></div>
      <div class="settings-option" style="align-items:flex-start"><span>System prompt</span><textarea id="botPrompt" rows="5" style="flex:1;background:#0d1218;border:1px solid #1e2630;color:#e6e6e6;border-radius:6px;padding:8px;width:100%">You are a specialized assistant.</textarea></div>
    </div>
    <div class="side-actions" style="margin-top:10px;display:flex;gap:8px;">
      <button class="btn primary" id="botCreate">Create bot</button>
      <button class="btn ghost" id="botDelete">Delete selected</button>
    </div>
  </div></div>

  <div id="ensembleModal" class="settings-modal"><div class="settings-content" style="max-width:760px">
    <div class="settings-header"><h2>Ensemble settings</h2><button class="settings-close" id="ensembleClose">√ó</button></div>
    <div class="settings-group">
      <h3 class="settings-group-title">Mode</h3>
      <div class="settings-option"><span>Mode</span>
        <select id="ensembleMode" style="background:#0d1218;border:1px solid #1e2630;color:#e6e6e6;border-radius:6px;padding:6px;width:220px">
          <option value="committee" selected>committee (multi-model + judge)</option>
          <option value="router">router (choose one model)</option>
          <option value="cascade">cascade (try models sequentially)</option>
        </select>
      </div>
    </div>
    <div class="settings-group">
      <h3 class="settings-group-title">Models pool</h3>
      <div class="settings-option" style="align-items:flex-start">
        <span>Models (JSON or CSV)</span>
        <textarea id="ensembleModels" rows="6" style="flex:1;background:#0d1218;border:1px solid #1e2630;color:#e6e6e6;border-radius:6px;padding:8px;width:100%" placeholder='[
  {"provider":"openai","model":"gpt-4o-mini"},
  {"provider":"anthropic","model":"claude-3-5-sonnet-latest"}
]'></textarea>
      </div>
      <div class="settings-option">
        <button class="btn" id="ensembleLoad">Load defaults</button>
        <button class="btn primary" id="ensembleSave">Save</button>
      </div>
    </div>
  </div></div>

  <div id="skillsModal" class="settings-modal"><div class="settings-content" style="max-width:760px">
    <div class="settings-header"><h2>Skills</h2><button class="settings-close" id="skillsClose">√ó</button></div>
    <div class="settings-group">
      <h3 class="settings-group-title">Create Skill</h3>
      <div class="settings-option"><span>Name</span><input id="skillName" style="background:#0d1218;border:1px solid #1e2630;color:#e6e6e6;border-radius:6px;padding:6px;width:240px" placeholder="backup logs"></div>
      <div class="settings-option"><span>Command</span><input id="skillCmd" style="background:#0d1218;border:1px solid #1e2630;color:#e6e6e6;border-radius:6px;padding:6px;width:420px" placeholder="tar czf /tmp/logs-{0}.tgz /var/log"></div>
      <div class="settings-option"><span>Tags</span><input id="skillTags" style="background:#0d1218;border:1px solid #1e2630;color:#e6e6e6;border-radius:6px;padding:6px;width:300px" placeholder="ops,backup"></div>
      <div class="settings-option"><span>Root?</span><input type="checkbox" id="skillRoot"></div>
      <div class="settings-option"><button class="btn primary" id="skillCreate">Create</button></div>
    </div>
    <div class="settings-group">
      <h3 class="settings-group-title">My Skills</h3>
      <div class="settings-option"><span>Filter</span><input id="skillsFilter" placeholder="name or tag" style="background:#0d1218;border:1px solid #1e2630;color:#e6e6e6;border-radius:6px;padding:6px;width:240px"></div>
      <div class="settings-option" style="align-items:flex-start"><span>List</span><div id="skillsList" style="flex:1;max-height:280px;overflow:auto"></div></div>
    </div>
    <div class="settings-group">
      <h3 class="settings-group-title">Add Skill from JSON</h3>
      <div class="settings-option" style="align-items:flex-start"><span>JSON</span><textarea id="skillJson" rows="6" style="flex:1;background:#0d1218;border:1px solid #1e2630;color:#e6e6e6;border-radius:6px;padding:8px;width:100%" placeholder='{"name":"sys_update","cmd":"dnf upgrade -y","is_root":true,"tags":["ops","system"]}'></textarea></div>
      <div class="settings-option"><button class="btn" id="skillJsonAdd">Add</button></div>
    </div>
  </div></div>

  <div id="ensPromptModal" class="settings-modal"><div class="settings-content" style="max-width:740px">
    <div class="settings-header"><h2>Ensemble (this message)</h2><button class="settings-close" id="ensPromptClose">√ó</button></div>
    <div class="settings-group">
      <h3 class="settings-group-title">Override for next message</h3>
      <div class="settings-option"><span>Mode</span>
        <select id="ensOnceMode" style="background:#0d1218;border:1px solid #1e2630;color:#e6e6e6;border-radius:6px;padding:6px;width:220px">
          <option value="committee" selected>committee</option>
          <option value="router">router</option>
          <option value="cascade">cascade</option>
        </select>
      </div>
      <div class="settings-option" style="align-items:flex-start">
        <span>Models (JSON or CSV)</span>
        <textarea id="ensOnceModels" rows="5" style="flex:1;background:#0d1218;border:1px solid #1e2630;color:#e6e6e6;border-radius:6px;padding:8px;width:100%" placeholder='openai:gpt-4o-mini, anthropic:claude-3-5-sonnet-latest'></textarea>
      </div>
      <div class="settings-option">
        <button class="btn primary" id="ensOnceApply">Apply for next message</button>
        <button class="btn" id="ensOnceClear">Clear</button>
      </div>
    </div>
  </div></div>

  <script>
    // ---------- State ----------
    const board = document.getElementById('board');
    const wsStateEl = document.getElementById('wsState');
    const statusIndicator = document.getElementById('statusIndicator');
    const reconnectBtn = document.getElementById('reconnect');
    const modelSel = document.getElementById('model');
    const providerSel = document.getElementById('provider');
    const modelActive = document.getElementById('modelActive');
    const providerActive = document.getElementById('providerActive');
    const temp = document.getElementById('temp');
    const tempVal = document.getElementById('tempVal');
    const maxTokens = document.getElementById('maxTokens');
    const streamChk = document.getElementById('stream');
    const input = document.getElementById('input');
    const sendBtn = document.getElementById('send');
    const stopBtn = document.getElementById('stop');
    const clearBtn = document.getElementById('clearBtn');
    const newChatBtn = document.getElementById('newChat');
    const exportBtn = document.getElementById('exportChat');
    const clearHistBtn = document.getElementById('clearHistory');
    const historyList = document.getElementById('historyList');
    const toastEl = document.getElementById('toast');
    const mobileMenuBtn = document.getElementById('mobileMenuBtn');
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('overlay');
    const scrollToBottomBtn = document.getElementById('scrollToBottom');
    const welcomeContainer = document.getElementById('welcomeContainer');
    const settingsBtn = document.getElementById('settingsBtn');
    const dbHdr = document.getElementById('dbHdr');
    const dbInitBtn = document.getElementById('dbInitBtn');
    const dbModal = document.getElementById('dbModal');
    const dbClose = document.getElementById('dbClose');
    const dbStatus = document.getElementById('dbStatus');
    const dbSQL = document.getElementById('dbSQL');
    const dbCopy = document.getElementById('dbCopy');
    const dbRefresh = document.getElementById('dbRefresh');
    const dbOpen = document.getElementById('dbOpen');
    const settingsModal = document.getElementById('settingsModal');
    const settingsClose = document.getElementById('settingsClose');
    const saveSettingsBtn = document.getElementById('saveSettings');
    const resetSettingsBtn = document.getElementById('resetSettings');

    // Bots / Ensemble UI elements
    const botSelect = document.getElementById('botSelect');
    const botsBtn = document.getElementById('botsBtn');
    const botModal = document.getElementById('botModal');
    const botClose = document.getElementById('botClose');
    const ensembleBtn = document.getElementById('ensembleBtn');
    const skillsBtn = document.getElementById('skillsBtn');
    const skillsModal = document.getElementById('skillsModal');
    const skillsClose = document.getElementById('skillsClose');
    const skillName = document.getElementById('skillName');
    const skillCmd = document.getElementById('skillCmd');
    const skillRoot = document.getElementById('skillRoot');
    const skillTags = document.getElementById('skillTags');
    const skillCreate = document.getElementById('skillCreate');
    const skillsList = document.getElementById('skillsList');
    const skillsFilter = document.getElementById('skillsFilter');
    const skillJson = document.getElementById('skillJson');
    const skillJsonAdd = document.getElementById('skillJsonAdd');
    const ensembleModal = document.getElementById('ensembleModal');
    const ensembleClose = document.getElementById('ensembleClose');
    const ensembleModeSel = document.getElementById('ensembleMode');
    const ensembleModelsTA = document.getElementById('ensembleModels');
    const ensembleLoadBtn = document.getElementById('ensembleLoad');
    const ensembleSaveBtn = document.getElementById('ensembleSave');

    const ensPromptBtn = document.getElementById('ensPromptBtn');
    const ensPromptModal = document.getElementById('ensPromptModal');
    const ensPromptClose = document.getElementById('ensPromptClose');
    const ensOnceMode = document.getElementById('ensOnceMode');
    const ensOnceModels = document.getElementById('ensOnceModels');
    const ensOnceApply = document.getElementById('ensOnceApply');
    const ensOnceClear = document.getElementById('ensOnceClear');

    const WS_URL = (location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host + '/ws';
    let ws, connected = false, abortStream = false, currentSessionId = null, currentReqId = null;
    let sseAbortCtrl = null; // AbortController for SSE requests
    let botMessageElement = null; // Reference to the current bot message element
    let reconnectAttempts = 0;
    let reconnectTimeout = null;
    let isAtBottom = true;

    // ---------- Helpers ----------
    function toast(msg, type = 'info', duration = 3000) {
      toastEl.textContent = msg;
      toastEl.className = 'toast';
      toastEl.classList.add(type);
      toastEl.classList.add('show');
      setTimeout(() => toastEl.classList.remove('show'), duration);
    }
    
    function el(tag, cls, text = '') {
      const e = document.createElement(tag); 
      if (cls) e.className = cls; 
      if (text) e.textContent = text; 
      return e;
    }
    
    function appendMsg(role, text) {
      // Hide welcome message if it's the first message
      if (welcomeContainer.style.display !== 'none') {
        welcomeContainer.style.display = 'none';
      }
      
      const m = el('div', `msg ${role}`);
      
      // Format message with markdown-like rendering
      const formattedText = formatMessage(text);
      m.appendChild(formattedText);
      
      const meta = el('div', 'meta');
      meta.innerHTML = `
        <span>${role === 'me' ? 'you' : 'assistant'}</span>
        <span>¬∑</span>
        <span>${new Date().toLocaleTimeString()}</span>
      `;
      
      const copy = el('button', 'copy', 'Copy'); 
      copy.setAttribute('aria-label', 'Copy message');
      copy.addEventListener('click', () => {
        navigator.clipboard.writeText(m.textContent || '');
        toast('Message copied to clipboard', 'success');
      });
      
      m.appendChild(copy); 
      m.appendChild(meta);
      board.appendChild(m);
      
      // Enhance with 'Run as root' buttons for code blocks and parse RUN_ directives
      try { attachOpsButtons(m); attachRunDirectives(m, text); } catch (e) {}
      
      // Scroll to bottom if auto-scroll is enabled
      if (isAtBottom) {
        board.scrollTo({ top: board.scrollHeight, behavior: 'smooth' });
      }
      
      // Show/hide scroll to bottom button
      updateScrollButton();
      
      return m;
    }
    
    function formatMessage(text) {
      const container = document.createElement('div');
      
      // Handle empty message
      if (!text || text.trim() === '') {
        container.innerHTML = '<p><i>Empty response</i></p>';
        return container;
      }
      
      // Simple markdown parsing
      const lines = text.split('\n');
      let inCodeBlock = false;
      let codeLanguage = '';
      let codeContent = [];
      
      for (let i = 0; i < lines.length; i++) {
        let line = lines[i];
        
        // Code blocks
        if (line.startsWith('```')) {
          if (inCodeBlock) {
            // End of code block
            const pre = el('pre');
            const code = el('code', codeLanguage);
            code.textContent = codeContent.join('\n');
            pre.appendChild(code);
            container.appendChild(pre);
            
            inCodeBlock = false;
            codeContent = [];
            codeLanguage = '';
          } else {
            // Start of code block
            inCodeBlock = true;
            codeLanguage = line.replace(/```/, '').trim();
          }
          continue;
        }
        
        if (inCodeBlock) {
          codeContent.push(line);
          continue;
        }
        
        // Headers
        if (line.startsWith('### ')) {
          const h3 = el('h3');
          h3.textContent = line.slice(4);
          container.appendChild(h3);
          continue;
        }
        
        if (line.startsWith('## ')) {
          const h2 = el('h2');
          h2.textContent = line.slice(3);
          container.appendChild(h2);
          continue;
        }
        
        if (line.startsWith('# ')) {
          const h1 = el('h1');
          h1.textContent = line.slice(2);
          container.appendChild(h1);
          continue;
        }
        
        // Blockquotes
        if (line.startsWith('> ')) {
          const blockquote = el('blockquote');
          blockquote.textContent = line.slice(2);
          container.appendChild(blockquote);
          continue;
        }
        
        // Lists
        if (line.startsWith('- ') || line.startsWith('* ') || /^\d+\./.test(line)) {
          const listType = /^\d+\./.test(line) ? 'ol' : 'ul';
          const list = el(listType);
          
          while (i < lines.length && (lines[i].startsWith('- ') || lines[i].startsWith('* ') || /^\d+\./.test(lines[i]))) {
            const li = el('li');
            li.textContent = lines[i].replace(/^[-*]\s|^\d+\.\s/, '');
            list.appendChild(li);
            i++;
          }
          i--; // Adjust counter
          container.appendChild(list);
          continue;
        }
        
        // Horizontal rules
        if (line.match(/^[-*_]{3,}$/)) {
          container.appendChild(el('hr'));
          continue;
        }
        
        // Inline formatting
        if (line.includes('`') || line.includes('**') || line.includes('*') || line.includes('_')) {
          const p = el('p');
          let formattedLine = line;
          
          // Code
          formattedLine = formattedLine.replace(/`([^`]+)`/g, '<code>$1</code>');
          
          // Bold
          formattedLine = formattedLine.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
          formattedLine = formattedLine.replace(/__([^_]+)__/g, '<strong>$1</strong>');
          
          // Italic
          formattedLine = formattedLine.replace(/\*([^*]+)\*/g, '<em>$1</em>');
          formattedLine = formattedLine.replace(/_([^_]+)_/g, '<em>$1</em>');
          
          p.innerHTML = formattedLine;
          container.appendChild(p);
          continue;
        }
        
        // Default paragraph
        if (line.trim()) {
          const p = el('p');
          p.textContent = line;
          container.appendChild(p);
        } else if (i < lines.length - 1) {
          // Add spacing between paragraphs
          container.appendChild(el('br'));
        }
      }
      
      // Handle case where code block isn't properly closed
      if (inCodeBlock && codeContent.length > 0) {
        const pre = el('pre');
        const code = el('code', codeLanguage);
        code.textContent = codeContent.join('\n');
        pre.appendChild(code);
        container.appendChild(pre);
      }
      
      return container;
    }
    
    function updateMsg(m, delta) {
      const lastChild = m.lastElementChild;
      if (lastChild && lastChild.className === 'typing-indicator') {
        m.removeChild(lastChild);
      }
      
      // Create a text node for streaming if it doesn't exist
      if (!m.__streamTextNode) {
        const textNode = document.createTextNode('');
        m.querySelector('div').appendChild(textNode);
        m.__streamTextNode = textNode;
      }
      
      m.__streamTextNode.textContent += delta;
      
      // As soon as we have a code fence in streamed content, attach run buttons
      try { attachOpsButtons(m); } catch (e) {}
      
      // Scroll to bottom if auto-scroll is enabled
      if (isAtBottom) {
        board.scrollTo({ top: board.scrollHeight, behavior: 'smooth' });
      }
      
      // Show/hide scroll to bottom button
      updateScrollButton();
    }
    
    function showTypingIndicator() {
      const typingIndicator = el('div', 'typing-indicator');
      typingIndicator.appendChild(el('span', 'typing-dot'));
      typingIndicator.appendChild(el('span', 'typing-dot'));
      typingIndicator.appendChild(el('span', 'typing-dot'));
      typingIndicator.appendChild(document.createTextNode('Thinking...'));
      board.appendChild(typingIndicator);
      
      // Scroll to bottom if auto-scroll is enabled
      if (isAtBottom) {
        board.scrollTo({ top: board.scrollHeight, behavior: 'smooth' });
      }
      
      return typingIndicator;
    }
    
    function updateScrollButton() {
      const scrollThreshold = 100;
      const distanceFromBottom = board.scrollHeight - board.scrollTop - board.clientHeight;
      isAtBottom = distanceFromBottom <= scrollThreshold;
      
      if (isAtBottom) {
        scrollToBottomBtn.classList.remove('visible');
      } else {
        scrollToBottomBtn.classList.add('visible');
      }
    }
    
    function scrollToBottom() {
      board.scrollTo({ top: board.scrollHeight, behavior: 'smooth' });
      isAtBottom = true;
      scrollToBottomBtn.classList.remove('visible');
    }

    // ---------- History Management ----------
    const SKEY = 'qc.history.v2';
    let sessions = JSON.parse(localStorage.getItem(SKEY) || '[]');
    
    function renderHistory() {
      historyList.innerHTML = '';
      if (!sessions.length) { 
        historyList.innerHTML = '<div class="hist-empty">No conversations yet.</div>'; 
        return; 
      }
      
      sessions.forEach((s, i) => {
        const item = el('div', 'hist-item');
        if (s.id === currentSessionId) {
          item.classList.add('active');
        }
        
        const title = el('div', 'hist-item-title', s.title || 'Untitled conversation');
        const time = el('div', 'hist-item-time', new Date(s.ts).toLocaleString());
        const deleteBtn = el('button', 'hist-item-delete', '√ó');
        
        deleteBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          deleteSession(i);
        });
        
        item.appendChild(title);
        item.appendChild(time);
        item.appendChild(deleteBtn);
        
        item.setAttribute('role', 'button');
        item.setAttribute('tabindex', '0');
        item.addEventListener('click', () => loadSession(i));
        item.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            loadSession(i);
          }
        });
        
        historyList.appendChild(item);
      });
    }
    
    function deleteSession(index) {
      if (index >= 0 && index < sessions.length) {
        const deletedId = sessions[index].id;
        sessions.splice(index, 1);
        
        // If the deleted session was the current one, clear the board
        if (currentSessionId === deletedId) {
          board.innerHTML = '';
          currentTranscript = [];
          currentSessionId = null;
          welcomeContainer.style.display = 'flex';
        }
        
        localStorage.setItem(SKEY, JSON.stringify(sessions));
        renderHistory();
        toast('Conversation deleted', 'success');
      }
    }
    
    function saveSession(title, transcript) {
      const sessionId = currentSessionId || Date.now().toString();
      
      // Check if we're updating an existing session
      const existingIndex = sessions.findIndex(s => s.id === sessionId);
      
      if (existingIndex >= 0) {
        sessions[existingIndex] = {
          ...sessions[existingIndex],
          ts: Date.now(),
          title: title || sessions[existingIndex].title,
          transcript
        };
      } else {
        sessions.unshift({
          id: sessionId,
          ts: Date.now(), 
          title: title || 'Untitled conversation', 
          transcript
        });
      }
      
      // Keep only the 50 most recent sessions
      sessions = sessions.slice(0, 50);
      localStorage.setItem(SKEY, JSON.stringify(sessions));
      currentSessionId = sessionId;
      renderHistory();
    }
    
    function loadSession(idx) {
      const s = sessions[idx]; 
      if (!s) return;
      
      board.innerHTML = '';
      s.transcript.forEach(r => appendMsg(r.role, r.text));
      currentSessionId = s.id;
      currentTranscript = [...s.transcript];
      renderHistory();
      toast('Loaded: ' + (s.title || 'Untitled conversation'), 'success');
      closeSidebar();
    }

    // Initialize history
    renderHistory();

    // ---------- Settings Management ----------
    const SETTINGS_KEY = 'qc.settings.v1';
    let settings = JSON.parse(localStorage.getItem(SETTINGS_KEY) || '{}');
    
    function loadSettings() {
      // Apply settings to UI elements
      if (settings.apiBaseUrl) document.getElementById('apiBaseUrl').value = settings.apiBaseUrl;
      if (settings.apiKey) document.getElementById('apiKey').value = settings.apiKey;
      if (settings.darkMode !== undefined) document.getElementById('darkMode').checked = settings.darkMode;
      if (settings.animations !== undefined) document.getElementById('animations').checked = settings.animations;
      if (settings.fontSize) document.getElementById('fontSize').value = settings.fontSize;
      if (settings.autoScroll !== undefined) document.getElementById('autoScroll').checked = settings.autoScroll;
      if (settings.sendWithEnter !== undefined) document.getElementById('sendWithEnter').checked = settings.sendWithEnter;
      if (settings.showTimestamps !== undefined) document.getElementById('showTimestamps').checked = settings.showTimestamps;
      if (settings.autoTransport !== undefined) document.getElementById('autoTransport').checked = settings.autoTransport;
      if (settings.chatRootExec !== undefined) document.getElementById('chatRootExec').checked = settings.chatRootExec;
      
      // Apply visual settings
      applyVisualSettings();
    }
    
    function saveSettings() {
      settings = {
        apiBaseUrl: document.getElementById('apiBaseUrl').value,
        apiKey: document.getElementById('apiKey').value,
        darkMode: document.getElementById('darkMode').checked,
        animations: document.getElementById('animations').checked,
        fontSize: document.getElementById('fontSize').value,
        autoScroll: document.getElementById('autoScroll').checked,
        sendWithEnter: document.getElementById('sendWithEnter').checked,
        showTimestamps: document.getElementById('showTimestamps').checked,
        autoTransport: document.getElementById('autoTransport').checked,
        chatRootExec: document.getElementById('chatRootExec').checked
      };
      
      localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
      applyVisualSettings();
      toast('Settings saved', 'success');
    }
    
    function resetSettings() {
      localStorage.removeItem(SETTINGS_KEY);
      settings = {};
      loadSettings();
      toast('Settings reset to defaults', 'success');
    }
    
    function applyVisualSettings() {
      // Apply dark mode
      if (settings.darkMode === false) {
        document.documentElement.style.setProperty('--bg', '#f8f9fa');
        document.documentElement.style.setProperty('--panel', '#ffffff');
        document.documentElement.style.setProperty('--card', '#f1f3f5');
        document.documentElement.style.setProperty('--ink', '#212529');
        document.documentElement.style.setProperty('--muted', '#868e96');
      } else {
        document.documentElement.style.setProperty('--bg', '#0b0c10');
        document.documentElement.style.setProperty('--panel', '#0f1318');
        document.documentElement.style.setProperty('--card', '#11161d');
        document.documentElement.style.setProperty('--ink', '#e6e6e6');
        document.documentElement.style.setProperty('--muted', '#9aa0a6');
      }
      
      // Apply font size
      if (settings.fontSize) {
        document.documentElement.style.fontSize = settings.fontSize;
      }
      
      // Apply animations
      if (settings.animations === false) {
        document.documentElement.style.setProperty('--transition', 'all 0s ease');
      } else {
        document.documentElement.style.setProperty('--transition', 'all 0.2s ease');
      }
    }
    
    // Load settings on startup
    loadSettings();

    // ---------- Health: seed providers/models/temp/max_tokens ----------
    async function initHealth() {
      try {
        const r = await fetch('/health', { cache: 'no-store' }); 
        const h = await r.json();
        const providers = h.available_providers || ['openai'];
        
        providerSel.innerHTML = providers.map(p => `<option value=\"${p}\">${p}</option>`).join('');
        providerSel.value = settings.provider || h.provider || providers[0];
        providerActive.textContent = providerSel.value;
        // DB header from stores
        try{
          const stores = h.stores||{}; const using = (stores.bots||'json');
          if (dbHdr) { dbHdr.textContent = `DB: ${using}`; dbHdr.title = JSON.stringify(stores); }
        }catch(e){}

        // Build merged list of models across providers for convenience
        const byProv = h.models_by_provider || {};
        let merged = [];
        try {
          merged = Array.from(new Set(Object.values(byProv).flat()));
        } catch(e) {
          merged = h.available_models || ['gpt-5','gpt-5-mini','gpt-4o-mini'];
        }
        if (!Array.isArray(merged) || merged.length === 0) {
          merged = ['gpt-5','gpt-5-mini','gpt-4o-mini'];
        }
        // Expose special aggregator option
        const modelsWithEnsemble = [...merged, 'ensemble'];
        modelSel.innerHTML = modelsWithEnsemble.map(m => `<option value=\"${m}\">${m}</option>`).join('');
        modelSel.value = settings.model || h.model || modelsWithEnsemble[0];
        modelActive.textContent = modelSel.value;

        temp.value = settings.temperature || h.temperature || 0.2; 
        tempVal.textContent = String(temp.value);
        maxTokens.value = settings.max_tokens || h.max_tokens || 800;
      } catch (e) {
        console.error('Health check failed:', e);
        providerSel.innerHTML = '<option value="openai">openai</option>';
        modelSel.innerHTML = '<option value="gpt-5">gpt-5</option><option value="gpt-5-mini">gpt-5-mini</option>';
        providerSel.value = 'openai';
        modelSel.value = 'gpt-5';
        providerActive.textContent = providerSel.value; 
        modelActive.textContent = modelSel.value;
        temp.value = 0.2;
        tempVal.textContent = '0.2';
        maxTokens.value = 800;
        toast('Failed to load provider info', 'error');
      }
    }

    initHealth().then(()=>{ try{ adjustTransportDefaults(); }catch(e){} });

    // DB modal wiring
    let lastDbStatus = null;
    async function refreshDb(){
      try{
        const r = await fetch('/supabase/status'); const j = await r.json(); lastDbStatus = j;
        if (dbStatus) dbStatus.textContent = JSON.stringify(j, null, 2);
        if (dbSQL && j.sql) dbSQL.value = j.sql;
      }catch(e){ if (dbStatus) dbStatus.textContent = 'status error'; }
    }
    dbInitBtn?.addEventListener('click', ()=>{ refreshDb(); dbModal?.classList.add('open'); });
    dbHdr?.addEventListener('click', ()=>{ refreshDb(); dbModal?.classList.add('open'); });
    dbClose?.addEventListener('click', ()=> dbModal?.classList.remove('open'));
    dbCopy?.addEventListener('click', async ()=>{ try{ await navigator.clipboard.writeText(dbSQL?.value||''); toast('Copied SQL','success'); }catch(e){ toast('Copy failed','error'); } });
    dbRefresh?.addEventListener('click', refreshDb);
    dbOpen?.addEventListener('click', ()=>{
      try{
        const url = (lastDbStatus && lastDbStatus.url) || '';
        if (!url){ toast('No SUPABASE_URL configured','error'); return; }
        const a = document.createElement('a');
        // SUPABASE_URL looks like https://<projectRef>.supabase.co
        const host = new URL(url).hostname; const ref = host.split('.')[0];
        const dash = `https://app.supabase.com/project/${ref}/sql`;
        a.href = dash; a.target = '_blank'; a.rel = 'noopener'; a.click();
      }catch(e){ toast('Open failed','error'); }
    });

    // ---- Bots API ----
    async function apiOrigin(){
      try{ const s=JSON.parse(localStorage.getItem('qc.settings.v1')||'{}'); return s.apiBaseUrl||window.location.origin; }catch(e){ return window.location.origin; }
    }
    async function listBots(){ const r = await fetch((await apiOrigin())+"/bots",{cache:"no-store"}); const j = await r.json(); return j.bots||[]; }
    async function createBot(payload){ const r = await fetch((await apiOrigin())+"/bots",{method:"POST",headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)}); if(!r.ok) throw new Error('create failed'); return (await r.json()).bot; }
    async function deleteBot(id){ const r = await fetch((await apiOrigin())+"/bots/"+id,{method:"DELETE"}); if(!r.ok) throw new Error('delete failed'); return true; }

    // ---- Extensions API ----
    async function extInstall(name, content){
      const tok = (localStorage.getItem('qc.ops_token')||'').trim();
      if (!tok) { toast('Set OPS_TOKEN in Root Ops first','warning'); throw new Error('No OPS_TOKEN'); }
      const r = await fetch('/extensions/install',{
        method:'POST',
        headers:{'Content-Type':'application/json','X-OPS-TOKEN': tok},
        body: JSON.stringify({ name, content })
      });
      if(!r.ok){ const t = await r.text(); throw new Error('install failed: '+t); }
      return await r.json();
    }
    async function extCall(moduleName, funcName, args){
      const body = { module: moduleName, func: funcName, args: Array.isArray(args)? args : [] };
      const r = await fetch('/extensions/call',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(body)
      });
      if(!r.ok){ const t = await r.text(); throw new Error('call failed: '+t); }
      return await r.json();
    }

    async function refreshBotSelect(){
      try{
        const bots = await listBots();
        const val = botSelect?.value || "";
        if (botSelect) {
          botSelect.innerHTML = '<option value="">(none)</option>' + bots.map(b => `${"<option value=\""+b.id+"\">"}${(b.emoji||'ü§ñ')} ${b.name}</option>`).join("");
          if (bots.find(b=>b.id===val)) botSelect.value = val;
        }
      }catch(e){ console.error(e); }
    }

    // Bots UI wiring
    botsBtn?.addEventListener('click', async ()=>{ await refreshBotSelect(); botModal?.classList.add('open'); });
    botClose?.addEventListener('click', ()=> botModal?.classList.remove('open'));
    document.getElementById('botCreate')?.addEventListener('click', async ()=>{
      const payload = {
        name: (document.getElementById('botName')?.value) || 'New Bot',
        emoji: (document.getElementById('botEmoji')?.value) || 'ü§ñ',
        provider: (document.getElementById('botProvider')?.value) || 'openai',
        model: (document.getElementById('botModel')?.value) || 'gpt-5',
        temperature: parseFloat(((document.getElementById('botTemp')?.value) || '0.2')),
        max_tokens: parseInt(((document.getElementById('botMaxToks')?.value) || '800')),
        system_prompt: (document.getElementById('botPrompt')?.value) || 'You are a specialized assistant.'
      };
      try{ await createBot(payload); toast('Bot created','success'); await refreshBotSelect(); }catch(e){ toast('Create failed','error'); }
    });
    document.getElementById('botDelete')?.addEventListener('click', async ()=>{
      const id = botSelect?.value; if(!id){ toast('Select a bot first','warning'); return; }
      if(!confirm('Delete selected bot?')) return;
      try{ await deleteBot(String(id)); toast('Bot deleted','success'); await refreshBotSelect(); }catch(e){ toast('Delete failed','error'); }
    });
    window.addEventListener('load', refreshBotSelect);

    // Skills wiring
    async function fetchSkills(){ const r = await fetch('/skills'); const j = await r.json(); return j.skills||[]; }
    async function renderSkills(){
      try{
        let rows = await fetchSkills();
        const el = skillsList; if (!el) return;
        const q = (skillsFilter?.value||'').toLowerCase().trim();
        if (q){ rows = rows.filter(s=> (s.name||'').toLowerCase().includes(q) || (Array.isArray(s.tags)? s.tags.join(',').toLowerCase().includes(q): false)); }
        el.innerHTML = '';
        rows.forEach(s => {
          const row = document.createElement('div'); row.style.display='flex'; row.style.gap='8px'; row.style.alignItems='center'; row.style.margin='4px 0';
          const span = document.createElement('span'); span.textContent = `${s.name}  ${s.is_root ? '(root)' : ''}  ${Array.isArray(s.tags)&&s.tags.length? '['+s.tags.join(', ')+']':''}`; span.style.flex='1';
          const run = document.createElement('button'); run.className='btn btn-sm'; run.textContent='Run';
          const del = document.createElement('button'); del.className='btn btn-sm'; del.textContent='Delete';
          run.addEventListener('click', async()=>{
            const args = prompt('Args (space separated)? e.g., 2025-09-01') || '';
            const tok = (localStorage.getItem('qc.ops_token')||'');
            const body = { name: s.name, args: (args? args.split(/\s+/):[]) };
            try{
              const r = await fetch('/skills/run', { method:'POST', headers:{'Content-Type':'application/json','X-OPS-TOKEN': tok}, body: JSON.stringify(body) });
              if (r.status === 412){ if (!confirm('Skill requires confirmation; proceed?')) return; body.confirm = true; const r2 = await fetch('/skills/run', { method:'POST', headers:{'Content-Type':'application/json','X-OPS-TOKEN': tok}, body: JSON.stringify(body) }); const j2 = await r2.json(); alert((j2.stdout||'') + (j2.stderr? ('\n'+j2.stderr):'')); return; }
              const j = await r.json(); alert((j.stdout||'') + (j.stderr? ('\n'+j.stderr):''));
            }catch(e){ alert('Run failed: '+e); }
          });
          del.addEventListener('click', async()=>{ if(!confirm('Delete skill?')) return; try{ await fetch('/skills/'+s.id,{method:'DELETE'}); renderSkills(); }catch(e){ alert('Delete failed'); } });
          row.appendChild(span); row.appendChild(run); row.appendChild(del); el.appendChild(row);
        });
      }catch(e){ console.error(e); }
    }
    skillsBtn?.addEventListener('click', ()=>{ renderSkills(); skillsModal?.classList.add('open'); });
    skillsFilter?.addEventListener('input', ()=> renderSkills());
    skillsClose?.addEventListener('click', ()=> skillsModal?.classList.remove('open'));
    skillCreate?.addEventListener('click', async()=>{
      const name=(skillName?.value||'').trim(); const cmd=(skillCmd?.value||'').trim(); const is_root=!!(skillRoot?.checked); const tags=(skillTags?.value||'').split(',').map(x=>x.trim()).filter(Boolean);
      if(!name||!cmd){ toast('Enter name and command','error'); return; }
      try{ await fetch('/skills',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name,cmd,is_root,tags})}); toast('Skill created','success'); renderSkills(); }
      catch(e){ toast('Create failed','error'); }
    });

    skillJsonAdd?.addEventListener('click', async()=>{
      try{
        const v = JSON.parse(skillJson?.value||'{}');
        if (!v || !v.name || !v.cmd){ toast('Invalid JSON','error'); return; }
        await fetch('/skills',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(v)});
        toast('Skill added','success'); renderSkills();
      }catch(e){ toast('Add failed','error'); }
    });

    // Ensemble UI wiring
    function loadEnsembleFromSettings(){ try{
      if (settings.ensembleMode) ensembleModeSel.value = settings.ensembleMode;
      if (settings.ensembleModels) ensembleModelsTA.value = settings.ensembleModels; }catch(e){}
    }
    ensembleBtn?.addEventListener('click', ()=>{ loadEnsembleFromSettings(); ensembleModal?.classList.add('open'); });
    ensembleClose?.addEventListener('click', ()=> ensembleModal?.classList.remove('open'));
    ensembleLoadBtn?.addEventListener('click', async ()=>{
      try{ const r = await fetch('/ensemble/models'); const j = await r.json(); const def = j.models||[]; ensembleModelsTA.value = JSON.stringify(def, null, 2); toast('Defaults loaded','success'); }
      catch(e){ toast('Load failed','error'); }
    });
    ensembleSaveBtn?.addEventListener('click', ()=>{
      settings.ensembleMode = ensembleModeSel?.value || 'committee';
      settings.ensembleModels = ensembleModelsTA?.value || '';
      localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
      ensembleModal?.classList.remove('open');
      toast('Ensemble settings saved','success');
    });

    // Per-message overrides (gear)
    let ensOverride = null;
    // Load persisted one if present
    try{ if (settings && settings.ensOverride) ensOverride = settings.ensOverride; }catch(e){}
    function syncEnsPromptDefaults(){ try{ 
      // prefer override values if present
      if (ensOverride && (ensOverride.mode || ensOverride.models)){
        ensOnceMode.value = ensOverride.mode || (settings.ensembleMode || 'committee');
        ensOnceModels.value = ensOverride.models || (settings.ensembleModels || '');
      } else {
        ensOnceMode.value = settings.ensembleMode || 'committee'; 
        ensOnceModels.value = settings.ensembleModels || ''; 
      }
    }catch(e){} }
    ensPromptBtn?.addEventListener('click', ()=>{ syncEnsPromptDefaults(); ensPromptModal?.classList.add('open'); });
    ensPromptClose?.addEventListener('click', ()=> ensPromptModal?.classList.remove('open'));
    ensOnceApply?.addEventListener('click', ()=>{ 
      ensOverride = { mode: (ensOnceMode?.value||'committee'), models: (ensOnceModels?.value||'') };
      // persist across messages until cleared
      settings.ensOverride = ensOverride;
      localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
      ensPromptModal?.classList.remove('open'); 
      try{ adjustTransportDefaults(); }catch(e){}
      toast('Override active (persists until cleared)','success'); 
    });
    ensOnceClear?.addEventListener('click', ()=>{ 
      ensOverride = null; 
      try{ delete settings.ensOverride; }catch(e){}
      localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
      ensPromptModal?.classList.remove('open'); 
      try{ adjustTransportDefaults(); }catch(e){}
      toast('Override cleared','success'); 
    });

    // Helpers for override badge
    function getEnsOverride(){ try{ return ensOverride || (settings && settings.ensOverride) || null; }catch(e){ return ensOverride; } }

    // Open Root Ops modal and pre-fill command
    function openOpsWith(cmd){
      try{
        if (opsCmd) opsCmd.value = (cmd||'').trim();
        if (opsModal) opsModal.classList.add('open');
        try{ const saved = localStorage.getItem('qc.ops_token'); if (saved && opsTokenEl && !opsTokenEl.value) opsTokenEl.value = saved; }catch(e){}
        if (opsCmd) opsCmd.focus();
      }catch(e){}
    }

    function stripPrompts(txt){ try{ return (txt||'').split('\n').map(l => l.replace(/^\s*[$#]\s+/, '')).join('\n').trim(); }catch(e){ return txt||''; } }
    function currentSelectionText(){
      try{
        const sel = (window.getSelection && window.getSelection().toString()) || '';
        if (sel && sel.trim()) return sel.trim();
        const ae = document.activeElement;
        if (ae && typeof ae.value === 'string') {
          const start = ae.selectionStart||0, end = ae.selectionEnd||0;
          if (end>start) return ae.value.substring(start,end).trim();
        }
      }catch(e){}
      return '';
    }

    // Parse plain text directives emitted by the assistant and render action buttons.
    // Supported:
    //  - RUN_ROOT: <cmd>
    //  - RUN_USER: <cmd>
    //  - EXT_INSTALL: <name>.py   (uses /extensions/install; code is taken from the first code block in this message)
    //  - EXT_CALL: <module>:<func> [args=<JSON array>]
    function attachRunDirectives(msgEl, rawText){
      try{
        if (!rawText || typeof rawText !== 'string') return;

        // ---- RUN_* directives ----
        const runMatches = Array.from(rawText.matchAll(/^RUN_(ROOT|USER):\s*(.+)$/gim));
        if (runMatches.length) {
          const row = document.createElement('div'); row.style.display='flex'; row.style.gap='8px'; row.style.margin='6px 0';
          runMatches.forEach(m=>{
            const kind = (m[1]||'').toUpperCase(); const cmd = (m[2]||'').trim();
            const btn = document.createElement('button'); btn.className='btn btn-sm';
            btn.textContent = kind==='ROOT' ? `Run as root: ${cmd.slice(0,28)}` : `Run (user): ${cmd.slice(0,28)}`;
            btn.addEventListener('click', ()=>{ if(kind==='ROOT') openOpsWith(cmd); else window.open('/user-terminal?cmd='+encodeURIComponent(cmd),'_blank'); });
            row.appendChild(btn);
          });
          msgEl.appendChild(row);
        }

        // ---- EXT_INSTALL / EXT_CALL directives ----
        // Extract first code block content for install payload
        const codeEl = msgEl.querySelector('pre code');
        const codeText = codeEl ? (codeEl.textContent || '') : '';

        // EXT_INSTALL: <name>.py
        const installMatches = Array.from(rawText.matchAll(/^EXT_INSTALL:\s*(.+)$/gim));
        // EXT_CALL: module:function [args=JSON]
        const callMatches = Array.from(rawText.matchAll(/^EXT_CALL:\s*(.+)$/gim));
        if (installMatches.length || callMatches.length) {
          const row2 = document.createElement('div'); row2.style.display='flex'; row2.style.gap='8px'; row2.style.margin='6px 0';

          installMatches.forEach(m=>{
            const nameRaw = (m[1]||'').trim();
            const name = nameRaw.replace(/^\s+|\s+$/g,'');
            const btnI = document.createElement('button'); btnI.className='btn btn-sm';
            btnI.textContent = `Install: ${name.slice(0,28)}`;
            btnI.addEventListener('click', async()=>{
              try{
                if (!codeText){ toast('No code block found in message','error'); return; }
                await extInstall(name, codeText);
                toast(`Installed ${name}`,'success');
              }catch(e){ toast('Install failed: '+e.message,'error'); }
            });
            row2.appendChild(btnI);
          });

          callMatches.forEach(m=>{
            const spec = (m[1]||'').trim();
            let mod = '', fn = 'main', args = [];
            try{
              // Try formats: "module:function [args=JSON]" or "module:function" or "module=.. func=.. args=.."
              const kv = Object.fromEntries(Array.from(spec.matchAll(/(module|mod|m|func|fn|f|args)\s*=\s*([^\s]+|\[[\s\S]*\]|\{[\s\S]*\})/gi)).map(x=>[x[1].toLowerCase(), x[2]]));
              if (Object.keys(kv).length){
                mod = (kv.module||kv.mod||kv.m||'').replace(/^extensions\./,'');
                fn = (kv.func||kv.fn||kv.f||'main');
                if (kv.args){ try{ args = JSON.parse(kv.args); }catch(_){} }
              } else if (spec.includes(':')) {
                const parts = spec.split(':'); mod = parts[0].trim().replace(/^extensions\./,'');
                const rest = parts.slice(1).join(':').trim();
                const m2 = rest.match(/^(\w+)(?:.*?args\s*=\s*(\[[\s\S]*\]|\{[\s\S]*\}))?/i);
                if (m2){ fn = m2[1]; if (m2[2]){ try{ args = JSON.parse(m2[2]); }catch(_){} } }
              } else {
                mod = spec.trim().replace(/^extensions\./,'');
              }
            }catch(_){ /* ignore parse errors */ }
            const btnC = document.createElement('button'); btnC.className='btn btn-sm';
            btnC.textContent = `Call: ${mod||'?'}:${fn}`;
            btnC.addEventListener('click', async()=>{
              try{
                if (!mod){ toast('EXT_CALL missing module','error'); return; }
                const res = await extCall(mod, fn, args);
                toast('Call ok','success');
                try{ if (res && typeof res.result !== 'undefined'){ console.log('[extensions.call]', res.result); } }catch(e){}
              }catch(e){ toast('Call failed: '+e.message,'error'); }
            });
            row2.appendChild(btnC);

            // If we also have an install name in this message, offer Install+Call
            const installName = installMatches.length ? (installMatches[0][1]||'').trim() : '';
            if (installName){
              const btnIC = document.createElement('button'); btnIC.className='btn btn-sm';
              btnIC.textContent = `Install+Call`;
              btnIC.addEventListener('click', async()=>{
                try{
                  if (!codeText){ toast('No code block found in message','error'); return; }
                  await extInstall(installName, codeText);
                  const mname = (mod||installName.replace(/\.py$/,''));
                  const res = await extCall(mname, fn, args);
                  toast('Installed and called','success');
                  try{ if (res && typeof res.result !== 'undefined'){ console.log('[extensions.call]', res.result); } }catch(e){}
                }catch(e){ toast('Install+Call failed: '+e.message,'error'); }
              });
              row2.appendChild(btnIC);
            }
          });

          if (row2.childElementCount>0) msgEl.appendChild(row2);
        }
      }catch(e){}
    }

    // Global shortcut: Ctrl+Shift+R opens Root Ops with selected text or input content
    document.addEventListener('keydown', (e)=>{
      try{
        if (e.ctrlKey && e.shiftKey && (e.key==='R' || e.key==='r' || e.code==='KeyR')){
          e.preventDefault();
          let txt = currentSelectionText();
          if (!txt && input && input.value) txt = input.value;
          txt = stripPrompts(txt||'');
          openOpsWith(txt);
        }
      }catch(err){}
    });

    // Attach 'Run as root' buttons to code blocks within a message element
    function attachOpsButtons(msgEl){
      try{
        const preBlocks = msgEl.querySelectorAll('pre');
        preBlocks.forEach(pre => {
          if (pre.__qcOpsButtonAttached) return;
          pre.__qcOpsButtonAttached = true;
          const row = document.createElement('div');
          row.style.display='flex'; row.style.gap='8px'; row.style.marginTop='6px';
          const btn = document.createElement('button');
          btn.className = 'btn btn-sm';
          btn.textContent = 'Run as root';
          const btnUser = document.createElement('button');
          btnUser.className = 'btn btn-sm';
          btnUser.textContent = 'Run (user)';
          const btnCopy = document.createElement('button');
          btnCopy.className = 'btn btn-sm';
          btnCopy.textContent = 'Copy';
          function extract(){
            const codeEl = pre.querySelector('code');
            let txt = (codeEl ? codeEl.textContent : pre.textContent) || '';
            return txt.split('\n').map(l => l.replace(/^\s*[$#]\s+/, '')).join('\n').trim();
          }
          btn.addEventListener('click', () => { openOpsWith(extract()); });
          btnUser.addEventListener('click', () => { const txt=extract(); window.open('/user-terminal?cmd='+encodeURIComponent(txt),'_blank'); });
          btnCopy.addEventListener('click', async () => { try{ await navigator.clipboard.writeText(extract()); toast('Copied','success'); }catch(e){ toast('Copy failed','error'); } });
          row.appendChild(btn); row.appendChild(btnUser); row.appendChild(btnCopy);
          pre.parentNode.insertBefore(row, pre.nextSibling);
        });
      }catch(e){}
    }
    function overrideSummary(){
      try{
        const ov = getEnsOverride();
        if (!ov) return '';
        const mode = ov.mode || settings.ensembleMode || 'committee';
        let models = ov.models || settings.ensembleModels || '';
        let csv = '';
        try {
          const parsed = JSON.parse(models);
          if (Array.isArray(parsed)) {
            csv = parsed.map(m => `${(m.provider||'')}:${(m.model||'')}`).join(', ');
          }
        } catch(e) {
          // not JSON, assume CSV already
          csv = String(models||'');
        }
        csv = csv.trim();
        const maxLen = 220;
        if (csv.length > maxLen) csv = csv.slice(0, maxLen) + '‚Ä¶';
        return `mode: ${mode}\npool: ${csv}`;
      }catch(e){ return ''; }
    }

    // Update settings when options change
    // Smart transport defaults based on provider/model
    function adjustTransportDefaults(){
      try{
        if (settings && settings.autoTransport === false) return; // user disabled
        const prov = (providerSel?.value||'').toLowerCase();
        const model = (modelSel?.value||'').toLowerCase();
        const isEnsemble = model === 'ensemble';
        // Toggle header badges and per-message gear
        const hdr = document.getElementById('ensembleHdr');
        if (hdr) hdr.style.display = isEnsemble ? '' : 'none';
        const ovHdr = document.getElementById('ensOverrideHdr');
        const hasOv = !!( (ensOverride && (ensOverride.mode || ensOverride.models)) || (settings && settings.ensOverride) );
        if (ovHdr) {
          ovHdr.style.display = (isEnsemble && hasOv) ? '' : 'none';
          ovHdr.title = hasOv ? overrideSummary() : '';
        }
        if (ensPromptBtn) ensPromptBtn.style.display = isEnsemble ? '' : 'none';
        // For gpt-5 (OpenAI) or special 'ensemble', default to non-stream over WS for reliability
        if ((prov === 'openai' && model.startsWith('gpt-5')) || isEnsemble) {
          if (transportSel) transportSel.value = 'ws';
          if (streamChk) streamChk.checked = false;
        } else {
          if (transportSel) transportSel.value = 'ws';
          if (streamChk) streamChk.checked = true;
        }
      }catch(e){ /* ignore */ }
    }

    providerSel.addEventListener('change', () => {
      providerActive.textContent = providerSel.value;
      settings.provider = providerSel.value;
      localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
      adjustTransportDefaults();
    });
    
    modelSel.addEventListener('change', () => {
      modelActive.textContent = modelSel.value;
      settings.model = modelSel.value;
      localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
      adjustTransportDefaults();
    });
    
    temp.addEventListener('input', () => {
      tempVal.textContent = String(temp.value);
      settings.temperature = parseFloat(temp.value);
      localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
    });
    
    maxTokens.addEventListener('change', () => {
      settings.max_tokens = parseInt(maxTokens.value, 10);
      localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
    });

    // ---------- Mobile sidebar ----------
    function toggleSidebar() {
      sidebar.classList.toggle('open');
      overlay.classList.toggle('open');
      document.body.style.overflow = sidebar.classList.contains('open') ? 'hidden' : '';
    }
    
    function closeSidebar() {
      sidebar.classList.remove('open');
      overlay.classList.remove('open');
      document.body.style.overflow = '';
    }
    
    mobileMenuBtn.addEventListener('click', toggleSidebar);
    overlay.addEventListener('click', closeSidebar);
    
    // Close sidebar when clicking outside on mobile
    document.addEventListener('click', (e) => {
      if (window.innerWidth <= 980 && 
          !sidebar.contains(e.target) && 
          e.target !== mobileMenuBtn &&
          sidebar.classList.contains('open')) {
        closeSidebar();
      }
    });
    
    // Close sidebar with Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeSidebar();
    });

    // ---------- WebSocket setup with exponential backoff ----------
    function connect() {
      // Clear any existing reconnect timeout
      if (reconnectTimeout) {
        clearTimeout(reconnectTimeout);
        reconnectTimeout = null;
      }
      
      // Close existing connection if any
      if (ws) {
        try {
          ws.close();
        } catch (e) {
          console.error('Error closing existing connection:', e);
        }
      }
      
      statusIndicator.className = 'status-indicator status-connecting';
      wsStateEl.innerHTML = '<span class="loading"></span> connecting‚Ä¶';
      
      ws = new WebSocket(WS_URL);
      
      ws.addEventListener('open', () => { 
        connected = true;
        reconnectAttempts = 0;
        statusIndicator.className = 'status-indicator status-connected';
        wsStateEl.textContent = 'connected';
        toast('Connected to server', 'success');
      });
      
      ws.addEventListener('close', () => { 
        connected = false; 
        statusIndicator.className = 'status-indicator status-disconnected';
        wsStateEl.textContent = 'disconnected';
        toast('Disconnected from server', 'error');
        
        // Exponential backoff for reconnection
        if (reconnectAttempts < 10) {
          const delay = Math.min(30000, Math.pow(2, reconnectAttempts) * 1000);
          reconnectTimeout = setTimeout(() => {
            reconnectAttempts++;
connect();
          }, delay);
        }
      });
      
      ws.addEventListener('error', () => { 
        statusIndicator.className = 'status-indicator status-disconnected';
        wsStateEl.textContent = 'error'; 
        toast('Connection error', 'error');
      });
      
      ws.addEventListener('message', onMessage);
    }
    
    reconnectBtn.addEventListener('click', () => { 
      reconnectAttempts = 0;
      connect(); 
      toast('Reconnecting...', 'info');
    });
    
    // Initial connection
    connect();

// ---------- Chat functionality ----------
const transportSel = document.getElementById('transport');
const uploadBtn = document.getElementById('uploadBtn');
const uploadModal = document.getElementById('uploadModal');
const uploadClose = document.getElementById('uploadClose');
const uploadDo = document.getElementById('uploadDo');
const uploadInput = document.getElementById('uploadInput');
const uploadList = document.getElementById('uploadList');
const chipFinance = document.getElementById('chipFinance');
const chipFund = document.getElementById('chipFund');
const chipLegal = document.getElementById('chipLegal');
const chipContent = document.getElementById('chipContent');
    const chipOps = document.getElementById('chipOps');
    const opsBtnHead = document.getElementById('opsBtnHead');
    const opsModal = document.getElementById('opsModal');
    const opsClose = document.getElementById('opsClose');
    const opsTokenEl = document.getElementById('opsToken');
    const opsSaveBtn = document.getElementById('opsSave');
    const opsTestBtn = document.getElementById('opsTest');
    const opsStatus = document.getElementById('opsStatus');
    const opsCmd = document.getElementById('opsCmd');
    const opsRunBtn = document.getElementById('opsRun');
    const opsConfirm = document.getElementById('opsConfirm');
    const opsOut = document.getElementById('opsOut');
    const opsOpenTerm = document.getElementById('opsOpenTerm');
    const opsSkillName = document.getElementById('opsSkillName');
    const opsSkillRoot = document.getElementById('opsSkillRoot');
    const opsSkillSave = document.getElementById('opsSkillSave');

// ---------- File uploads (moved out of reconnect timer) ----------
async function refreshFiles(){
  try{
    const r = await fetch('/files', { cache: 'no-store' });
    const j = await r.json();
    if (uploadList) {
      uploadList.textContent = (j.files||[])
        .map(f => `${f.name} (${Math.round((f.size||0)/1024)} KB)`).join('\n');
    }
  }catch(e){ console.error('refreshFiles failed', e); }
}

uploadBtn?.addEventListener('click', () => { uploadModal?.classList.add('open'); refreshFiles(); });
uploadClose?.addEventListener('click', () => uploadModal?.classList.remove('open'));
uploadDo?.addEventListener('click', async () => {
  const f = uploadInput?.files && uploadInput.files[0];
  if (!f) { toast('Pick a file','warning'); return; }
  const fd = new FormData();
  fd.append('file', f);
  try{
    const r = await fetch('/files/upload', { method: 'POST', body: fd });
    if (!r.ok) { toast('Upload failed','error'); return; }
    toast('Uploaded','success');
    refreshFiles();
  }catch(e){ toast('Upload failed','error'); }
});

// ---------- Quick-pick bot chips ----------
async function pickBotByName(name){
  try{
    const r = await fetch('/bots');
    const j = await r.json();
    const b = (j.bots||[]).find(x => (x.name||'').toLowerCase().includes(name));
    if (b) {
      const sel = document.getElementById('botSelect');
      if (sel) sel.value = b.id;
      toast(`${b.emoji||'ü§ñ'} ${b.name} selected`,'success');
    }
  }catch(e){ console.error(e); }
}
chipFinance?.addEventListener('click', ()=> pickBotByName('finance'));
chipFund?.addEventListener('click', ()=> pickBotByName('fundraiser'));
chipLegal?.addEventListener('click', ()=> pickBotByName('legal'));
chipContent?.addEventListener('click', ()=> pickBotByName('content'));
chipOps?.addEventListener('click', ()=> pickBotByName('ops'));
// Open Ops modal
opsBtnHead?.addEventListener('click', ()=>{
  try{ const saved = localStorage.getItem('qc.ops_token'); if (saved && opsTokenEl) opsTokenEl.value = saved; }catch(e){}
  opsModal?.classList.add('open');
});
opsClose?.addEventListener('click', ()=> opsModal?.classList.remove('open'));
opsSaveBtn?.addEventListener('click', ()=>{
  const tok = (opsTokenEl?.value||'').trim();
  if (!tok){ toast('Token required','error'); return; }
  try{ localStorage.setItem('qc.ops_token', tok); toast('Token saved','success'); }catch(e){ toast('Failed to save','error'); }
});
opsTestBtn?.addEventListener('click', async()=>{
  const tok = (opsTokenEl?.value||'').trim();
  opsStatus.textContent = 'testing‚Ä¶';
  try{
    const r = await fetch('/ops/health',{headers:{'X-OPS-TOKEN': tok||''}});
    if(r.ok){ opsStatus.textContent = 'ok'; toast('Ops OK','success'); }
    else { opsStatus.textContent = 'unauthorized'; toast('Unauthorized','error'); }
  }catch(e){ opsStatus.textContent = 'error'; toast('Test failed','error'); }
});
opsRunBtn?.addEventListener('click', async()=>{
  const tok = (opsTokenEl?.value||'').trim();
  const cmd = (opsCmd?.value||'').trim();
  if (!tok){ toast('Token required','error'); return; }
  if (!cmd){ toast('Enter a command','error'); return; }
  opsOut.textContent = 'running‚Ä¶';
  try{
    const r = await fetch('/ops/shell', { method:'POST', headers:{'Content-Type':'application/json','X-OPS-TOKEN': tok}, body: JSON.stringify({cmd, confirm: !!opsConfirm?.checked}) });
    if (r.status === 412){ const j = await r.json(); opsOut.textContent = 'Confirmation required: ' + (j?.detail?.preview||''); toast('Confirm destructive','warning'); return; }
    const j = await r.json();
    opsOut.textContent = JSON.stringify(j, null, 2);
    // suggest a skill name based on cmd
    try{
      const suggested = suggestSkillName(cmd);
      if (opsSkillName && !opsSkillName.value) opsSkillName.value = suggested;
      if (opsSkillRoot) opsSkillRoot.checked = true;
    }catch(e){}
  }catch(e){ opsOut.textContent = String(e); }
});

function suggestSkillName(cmd){
  try{
    const words = cmd.trim().split(/\s+/);
    if (!words.length) return 'custom skill';
    const tool = words[0];
    const rest = words.slice(1).filter(w=>!w.startsWith('-') && !w.startsWith('--') && !w.startsWith('/')).slice(0,3).join(' ');
    let name = tool + (rest? (' ' + rest) : '');
    name = name.replace(/\s+/g,' ').slice(0,48);
    return name;
  }catch(e){ return 'custom skill'; }
}

opsSkillSave?.addEventListener('click', async()=>{
  const name=(opsSkillName?.value||'').trim();
  const cmd=(opsCmd?.value||'').trim();
  const is_root=!!(opsSkillRoot?.checked);
  if(!name||!cmd){ toast('Enter name and command','error'); return; }
  try{ await fetch('/skills',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name,cmd,is_root})}); toast('Skill saved','success'); }
  catch(e){ toast('Save failed','error'); }
});
opsOpenTerm?.addEventListener('click', ()=>{
  try{ const tok = (opsTokenEl?.value||'').trim(); if (tok) localStorage.setItem('qc.ops_token', tok); }catch(e){}
  window.open('/terminal','_blank');
});

    function disableUI(dis) { 
      [input, sendBtn, stopBtn, streamChk, modelSel, providerSel, temp, maxTokens, clearBtn].forEach(el => {
        el.disabled = dis;
        el.setAttribute('aria-busy', dis);
      }); 
    }

    let currentTranscript = [];
    let typingIndicator = null;

    sendBtn.addEventListener('click', submitMessage);
    input.addEventListener('keydown', e => { 
      if (e.key === 'Enter' && !e.shiftKey && settings.sendWithEnter !== false) { 
        e.preventDefault(); 
        submitMessage(); 
      } 
    });
    
    stopBtn.addEventListener('click', () => { 
      abortStream = true; 
      try { if (ws && connected && currentReqId) { ws.send(JSON.stringify({ type: 'cancel', id: currentReqId })); } } catch(e) {}
      // Abort SSE if active
      try { if (sseAbortCtrl) { sseAbortCtrl.abort(); } } catch(e) {}
      sseAbortCtrl = null;
      if (typingIndicator && typingIndicator.parentNode) {
        typingIndicator.parentNode.removeChild(typingIndicator);
      }
      disableUI(false);
      toast('Response stopped', 'warning');
    });
    
    clearBtn.addEventListener('click', () => { 
      if (currentTranscript.length > 0) {
        if (!confirm('Are you sure you want to clear this conversation?')) return;
      }
      
      board.innerHTML = ''; 
      currentTranscript = []; 
      currentSessionId = null;
      renderHistory();
      welcomeContainer.style.display = 'flex';
      toast('Chat cleared', 'success');
    });

    newChatBtn.addEventListener('click', () => { 
      if (currentTranscript.length) {
        const title = (currentTranscript.find(r => r.role === 'me')?.text || 'Untitled').slice(0, 60);
        saveSession(title, currentTranscript);
      }
      board.innerHTML = ''; 
      currentTranscript = []; 
      currentSessionId = null;
      renderHistory();
      welcomeContainer.style.display = 'flex';
      toast('New chat created', 'success'); 
      closeSidebar();
    });

    exportBtn.addEventListener('click', () => {
      if (!currentTranscript.length) {
        toast('No messages to export', 'error');
        return;
      }
      
      const data = currentTranscript.map(r => `${r.role.toUpperCase()}: ${r.text}`).join('\n\n');
      const blob = new Blob([data], { type: 'text/plain' });
      const a = document.createElement('a'); 
      a.href = URL.createObjectURL(blob); 
      a.download = `quantum-commander-${new Date().toISOString().slice(0, 10)}.txt`; 
      a.click();
      toast('Transcript exported', 'success');
    });

    clearHistBtn.addEventListener('click', () => { 
      if (sessions.length === 0) {
        toast('No history to clear', 'info');
        return;
      }
      
      if (confirm('Are you sure you want to clear all conversation history? This cannot be undone.')) {
        sessions = []; 
        localStorage.removeItem(SKEY); 
        renderHistory(); 
        toast('History cleared', 'success'); 
        closeSidebar();
      }
    });

    scrollToBottomBtn.addEventListener('click', scrollToBottom);
    board.addEventListener('scroll', updateScrollButton);

    // Settings modal handlers
    settingsBtn.addEventListener('click', () => {
      settingsModal.classList.add('open');
    });
    
    settingsClose.addEventListener('click', () => {
      settingsModal.classList.remove('open');
    });
    
    saveSettingsBtn.addEventListener('click', () => {
      const before = settings.autoTransport;
      saveSettings();
      settingsModal.classList.remove('open');
      if (settings.autoTransport && before !== settings.autoTransport) {
        try { adjustTransportDefaults(); } catch(e){}
      }
    });
    
    resetSettingsBtn.addEventListener('click', () => {
      if (confirm('Are you sure you want to reset all settings to defaults?')) {
        resetSettings();
      }
    });

    // Close settings modal on outside click
    settingsModal.addEventListener('click', (e) => {
      if (e.target === settingsModal) {
        settingsModal.classList.remove('open');
      }
    });

function submitMessage(){
  const useSSE = (transportSel?.value||'ws') === 'sse';
      const text = input.value.trim(); 
      if (!text) { 
        toast('Please enter a message', 'error');
        return; 
      }

      // Intercept chat root exec commands: !root <cmd>
      if ((settings.chatRootExec === true) && /^\s*(!root|\/root)\s+/.test(text)){
        const cmd = text.replace(/^\s*(!root|\/root)\s+/, '').trim();
        (async ()=>{
          const userMsg = appendMsg('me', text);
          botMessageElement = appendMsg('bot', '');
          disableUI(true);
          let tok = '';
          try{ tok = localStorage.getItem('qc.ops_token')||''; }catch(e){}
          if(!tok){ disableUI(false); toast('Set OPS token first (Root Ops button)','error'); return; }
          try{
            // first try without confirm to see if server requests confirmation
            let r = await fetch('/ops/shell', {method:'POST', headers:{'Content-Type':'application/json','X-OPS-TOKEN': tok}, body: JSON.stringify({cmd, confirm:false})});
            if (r.status === 412){
              if (!confirm('Command may be destructive. Proceed as root?\n\n'+cmd)) { disableUI(false); return; }
              r = await fetch('/ops/shell', {method:'POST', headers:{'Content-Type':'application/json','X-OPS-TOKEN': tok}, body: JSON.stringify({cmd, confirm:true})});
            }
            const j = await r.json();
            const out = (j.stdout||'') + (j.stderr? ('\n'+j.stderr):'');
            const textOut = 'Root exec\n$ '+cmd+'\n\n'+(out||JSON.stringify(j,null,2));
            const contentDiv = botMessageElement.querySelector('div'); if(contentDiv) contentDiv.textContent = textOut; else botMessageElement.appendChild(document.createTextNode(textOut));
            currentTranscript.push({role:'bot', text: textOut});
          }catch(e){
            const contentDiv = botMessageElement.querySelector('div'); if(contentDiv) contentDiv.textContent = String(e); else botMessageElement.appendChild(document.createTextNode(String(e)));
          }finally{
            try{ fetch('/kb/index?'+new URLSearchParams({ text: 'chat-root: $ '+cmd, source:'chat-root'}), { method:'POST' }); }catch(e){}
            // Offer to save as skill
            try{
              if (confirm('Save this as a skill?')){
                const suggested = suggestSkillName(cmd);
                const name = prompt('Skill name:', suggested)||suggested;
                await fetch('/skills',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name,cmd,is_root:true,tags:['chat','root']})});
                toast('Skill saved','success');
              }
            }catch(e){}
            botMessageElement = null; disableUI(false); input.focus();
            if (currentTranscript.length) { const title=(currentTranscript.find(r=>r.role==='me')?.text||'Untitled').slice(0,60); saveSession(title, currentTranscript); }
          }
        })();
        // Clear input and exit
        input.value=''; input.style.height='auto';
        return;
      }
      
      if (!connected) { 
        toast('WebSocket not connected', 'error'); 
        return; 
      }
      
      const userMsg = appendMsg('me', text); 
      currentTranscript.push({ role: 'me', text });
      
      // Create bot message placeholder for streaming responses
      botMessageElement = appendMsg('bot', '');
      
      // Show typing indicator for streaming responses
      if (streamChk.checked) {
        typingIndicator = showTypingIndicator();
      }
      
      disableUI(true); 
      abortStream = false;

      const reqId = Date.now().toString();
      currentReqId = reqId;
      const payload = {
        id: reqId,
        message: text,
        stream: streamChk.checked,
        provider: providerSel.value,
        model: modelSel.value,
        temperature: parseFloat(temp.value),
        max_tokens: parseInt(maxTokens.value, 10),
        bot_id: botSelect?.value || ''
      };
      if ((modelSel?.value||'').toLowerCase() === 'ensemble'){
        let mode = (settings.ensembleMode || 'committee');
        let models = (settings.ensembleModels || '');
        if (ensOverride && (ensOverride.mode || ensOverride.models)){
          mode = ensOverride.mode || mode; models = ensOverride.models || models;
        }
        payload.ensemble_mode = mode;
        payload.ensemble_models = models;
      }

if (useSSE) {
        (async ()=>{
          try{
            const params = new URLSearchParams(Object.entries({
              message: text,
              provider: providerSel.value,
              model: modelSel.value,
              temperature: parseFloat(temp.value),
              max_tokens: parseInt(maxTokens.value,10),
              bot_id: (botSelect?.value||'')
            }));
            const ac = new AbortController();
            sseAbortCtrl = ac;
            const resp = await fetch(`/sse?${params.toString()}`, { signal: ac.signal, headers: { 'Accept': 'text/event-stream' } });
            if(!resp.ok){ toast('SSE start failed','error'); disableUI(false); sseAbortCtrl = null; return; }
            const reader = resp.body.getReader();
            const dec = new TextDecoder();
            let sseBuf = '';
            while(true){
              const {value, done} = await reader.read();
              if(done) break;
              sseBuf += dec.decode(value, { stream: true });
              let idx;
              while((idx = sseBuf.indexOf('\n\n')) !== -1){
                const frame = sseBuf.slice(0, idx);
                sseBuf = sseBuf.slice(idx + 2);
                const m = frame.match(/^event: (\w+)\ndata: (.*)$/s);
                if(!m) continue;
                const ev = m[1];
                const data = m[2];
                if(ev==='delta'){
                  const j=JSON.parse(data);
                  if(!botMessageElement) botMessageElement = appendMsg('bot','');
                  updateMsg(botMessageElement, j.delta||'');
                } else if (ev==='done') {
                  if (botMessageElement) {
                    currentTranscript.push({ role: 'bot', text: botMessageElement.textContent || '' });
                    botMessageElement = null;
                  }
                  currentReqId = null;
                  disableUI(false);
                  input.focus();
                  // Auto-save after SSE done
                  if (currentTranscript.length) {
                    const title = (currentTranscript.find(r => r.role === 'me')?.text || 'Untitled').slice(0, 60);
                    saveSession(title, currentTranscript);
                  }
                  toast('Response complete', 'success');
                }
              }
            }
            sseAbortCtrl = null;
            disableUI(false); input.focus();
          }catch(e){ 
            if (e && (e.name === 'AbortError' || e.code === 20)) {
              toast('SSE cancelled','warning');
            } else {
              toast('SSE error','error'); 
            }
            sseAbortCtrl = null;
            disableUI(false); 
          }
        })();
        return;
      }
      try { 
        ws.send(JSON.stringify(payload)); 
      } catch (e) { 
        disableUI(false); 
        toast('Send failed: ' + e, 'error'); 
        return; 
      }
      
      // Clear input
      input.value = '';
      input.style.height = 'auto';
    }

    function onMessage(ev) {
      let data; 
      try { 
        data = JSON.parse(ev.data); 
      } catch (e) { 
        console.error('Failed to parse message:', e, ev.data);
        return; 
      }

      // Remove typing indicator when we start receiving content
      if (typingIndicator && typingIndicator.parentNode) {
        typingIndicator.parentNode.removeChild(typingIndicator);
        typingIndicator = null;
      }

      // Streaming prelude
      if (data.stream === true && data.done === false) { 
        return; 
      }

      // Streaming delta
      if (typeof data.delta === 'string') {
        if (abortStream) { 
          return; 
        }
        
        // Ensure we have a bot message element to update
        if (!botMessageElement) {
          botMessageElement = appendMsg('bot', '');
        }
        
        updateMsg(botMessageElement, data.delta); 
        return;
      }

      // Streaming end
      if (data.done === true) {
        if (botMessageElement) {
          currentTranscript.push({ role: 'bot', text: botMessageElement.textContent || '' }); 
          botMessageElement = null;
        }
        currentReqId = null;
        disableUI(false); 
        input.focus(); 
        
        // Auto-save the session after each response
        if (currentTranscript.length) {
          const title = (currentTranscript.find(r => r.role === 'me')?.text || 'Untitled').slice(0, 60);
          saveSession(title, currentTranscript);
        }
        
        return;
      }

      // Single-shot response
      if (typeof data.response === 'string') {
        // For non-streaming responses, create a bot message if one doesn't exist
        if (!botMessageElement) {
          botMessageElement = appendMsg('bot', data.response);
        } else {
          // Update existing bot message
          const contentDiv = botMessageElement.querySelector('div');
          if (contentDiv) {
            contentDiv.textContent = data.response;
          }
        }
        // If meta indicates ensemble winner, annotate the message
        if (data.meta && botMessageElement) {
          try{
            const m = data.meta;
            const badge = [];
            if (m.mode) badge.push(`mode: ${m.mode}`);
            const w = m.winner || m.chosen || null;
            if (w && (w.provider || w.model)) badge.push(`winner: ${(w.provider||'')} ${(w.model||'')}`);
            if (typeof m.confidence === 'number') badge.push(`confidence: ${m.confidence.toFixed(2)}`);
            if (badge.length){
              const metaDiv = botMessageElement.querySelector('.meta');
              const span = document.createElement('span');
              span.textContent = '¬∑ ' + badge.join(' ¬∑ ');
              metaDiv?.appendChild(span);
            }
          }catch(e){}
        }
        // Candidate table if available
        if (data.meta && data.meta.candidates && Array.isArray(data.meta.candidates) && botMessageElement){
          try{
            const det = document.createElement('details');
            const sum = document.createElement('summary'); sum.textContent = 'Details'; det.appendChild(sum);
            // Copy buttons
            const btnRow = document.createElement('div'); btnRow.style.display='flex'; btnRow.style.gap='8px'; btnRow.style.margin='6px 0';
            const btnJson = document.createElement('button'); btnJson.className='btn btn-sm'; btnJson.textContent='Copy pool (JSON)';
            const btnCsv = document.createElement('button'); btnCsv.className='btn btn-sm'; btnCsv.textContent='Copy pool (CSV)';
            btnRow.appendChild(btnJson); btnRow.appendChild(btnCsv); det.appendChild(btnRow);
            const pool = (data.meta.candidates||[]).map(c=>c.model).filter(Boolean);
            btnJson.addEventListener('click', async ()=>{ try{ await navigator.clipboard.writeText(JSON.stringify(pool)); toast('Pool copied (JSON)','success'); }catch(e){ toast('Copy failed','error'); }});
            btnCsv.addEventListener('click', async ()=>{ try{ const csv=(pool||[]).map(m=>`${m.provider||''}:${m.model||''}`).join(', '); await navigator.clipboard.writeText(csv); toast('Pool copied (CSV)','success'); }catch(e){ toast('Copy failed','error'); }});
            const tbl = document.createElement('table');
            const thead = document.createElement('thead'); thead.innerHTML = '<tr><th>Provider</th><th>Model</th><th>Len</th><th>Confidence</th><th>Error</th></tr>'; tbl.appendChild(thead);
            const tb = document.createElement('tbody');
            for (const c of data.meta.candidates){
              const tr = document.createElement('tr');
              const prov = (c.model?.provider)||''; const mod = (c.model?.model)||'';
              tr.innerHTML = `<td>${prov||''}</td><td>${mod||''}</td><td>${c.len??''}</td><td>${(typeof c.confidence==='number'?c.confidence.toFixed(2):'')}</td><td>${c.error||''}</td>`;
              tb.appendChild(tr);
            }
            tbl.appendChild(tb);
            det.appendChild(tbl);
            botMessageElement.appendChild(det);
          }catch(e){}
        }
        
        currentTranscript.push({ role: 'bot', text: data.response }); 
        botMessageElement = null;
        disableUI(false); 
        input.focus(); 
        
        // Auto-save the session after each response
        if (currentTranscript.length) {
          const title = (currentTranscript.find(r => r.role === 'me')?.text || 'Untitled').slice(0, 60);
          saveSession(title, currentTranscript);
        }
        
        return;
      }

      if (data.error) { 
        toast('Error: ' + data.error, 'error'); 
        disableUI(false); 
      }
    }
    
    // Auto-resize textarea
    input.addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = (this.scrollHeight) + 'px';
    });
    
    // Focus the input on load
    window.addEventListener('load', () => {
      input.focus();
    });
  </script>
</body>
</html>
